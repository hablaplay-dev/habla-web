<!DOCTYPE html>
<html><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>window.FontAwesomeConfig={autoReplaceSvg:'nest'};</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
  
  <!-- Supabase JS desde CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <!-- Guardamos tus claves aqu√≠ solo para prototipo -->
  <script id="env" type="application/json">
  {
    "SUPABASE_URL": "https://ajogsubrgcsgrtieqffh.supabase.co",
    "SUPABASE_ANON_KEY": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFqb2dzdWJyZ2NzZ3J0aWVxZmZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTExMjgzMjIsImV4cCI6MjA2NjcwNDMyMn0.1ckGlWSAl6Bc9I2kKTlxwoUT-uVC9B2RostwOmnKuPY"
  }
  </script>
  <script>
    // Crear cliente de Supabase
    const ENV = JSON.parse(document.getElementById('env').textContent);
    const sb = supabase.createClient(ENV.SUPABASE_URL, ENV.SUPABASE_ANON_KEY);
    // Algunos navegadores est√°n ejecutando versiones de la librer√≠a de Supabase
    // sin la utiler√≠a interna `fetchMaybeNewAccessToken`, pero nuestro flujo
    // (y el propio auto-refresh de Supabase) intentan invocarla cuando existe
    // una sesi√≥n almacenada. Eso termina generando un error de consola
    // `fetchMaybeNewAccessToken is not a function` justo despu√©s de iniciar
    // sesi√≥n. Definimos un polyfill sencillo que delega al refresh oficial
    // disponible para garantizar la compatibilidad.
    if (sb?.auth && typeof sb.auth.fetchMaybeNewAccessToken !== 'function') {
      sb.auth.fetchMaybeNewAccessToken = async (refreshToken) => {
        try {
          // Supabase espera que la funci√≥n regrese la sesi√≥n fresca.
          const { data, error } = refreshToken
            ? await sb.auth.refreshSession({ refresh_token: refreshToken })
            : await sb.auth.refreshSession();
          if (error) throw error;
          return data?.session ?? null;
        } catch (err) {
          console.warn('[auth] Failed to refresh session', err);
          return null;
        }
      };
    }
    window.sb = sb;
  </script>

  <style>
    /* ===== Global styles (scroll habilitado) ===== */
    body { font-family: 'Inter', sans-serif; }
    /* Reusables */
    .strip{position:relative;overflow:hidden;border-radius:12px}
    .strip .side{display:flex;align-items:center;justify-content:center}
    .strip .center{background:linear-gradient(90deg,#0f172a 0%,#0b1220 100%);color:#fff;text-transform:uppercase;letter-spacing:.5px}
    .strip .line-1{font-weight:800}
    .strip .line-2,.strip .line-3{font-weight:700;opacity:.95}
    .pill{position:absolute;top:8px;left:8px;font-size:11px;background:rgba(0,0,0,.45);color:#fff;padding:2px 8px;border-radius:999px}
    .status-pill{padding:2px 8px;border-radius:999px;font-size:11px;font-weight:700;display:inline-flex;align-items:center;gap:6px}
    .status-dot{width:6px;height:6px;border-radius:999px}
    .dist-bar{height:8px;border-radius:999px;overflow:hidden}
	.card-hover:hover{ transform: translateY(-1px); box-shadow: 0 8px 20px rgba(0,0,0,.06); }

    /* Quita estilos que ocultaban el scrollbar (ANTES estaban duplicados) */
    /* ::-webkit-scrollbar{display:none}
       html,body{-ms-overflow-style:none;scrollbar-width:none} */
  </style>
  <script>tailwind.config = {
  "theme": {
    "extend": {
      "colors": {
        "primary": "#10B981",
        "secondary": "#3B82F6",
        "accent": "#F59E0B"
      },
      "fontFamily": {
        "sans": [
          "Inter",
          "sans-serif"
        ]
      }
    }
  }
};</script>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&amp;display=swap"><style>
  .highlighted-section {
    outline: 2px solid #3F20FB;
    background-color: rgba(63, 32, 251, 0.1);
  }
  .edit-button {
    position: absolute;
    z-index: 1000;
  }
  </style></head>
<body class="bg-gray-50">

  <!-- Header -->
  <header class="fixed top-0 left-0 right-0 bg-white border-b border-gray-200 z-50 h-16">
    <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
      <a class="flex items-center space-x-2" href="#" id="brand-home">
        <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center">
          <i class="fa-solid fa-futbol text-white text-sm"></i>
        </div>
        <span class="text-xl font-bold text-gray-900">Habla!</span>
      </a>

      <nav class="hidden lg:flex items-center space-x-8">
        <button id="nav-matches" class="text-primary font-semibold cursor-pointer">Matches</button>
        <button id="nav-results" class="text-gray-600 hover:text-gray-900 cursor-pointer">Results / Follow Live!</button>
        <button id="nav-rewards" class="text-gray-600 hover:text-gray-900 cursor-pointer">Rewards</button>
        <button id="nav-account" class="text-gray-600 hover:text-gray-900 cursor-pointer">Account</button>
      </nav>

      <div class="flex items-center space-x-3">
        <!-- Lukas (logueado) -->
        <div id="status-cluster" class="hidden items-center">
          <div class="px-3 py-1.5 rounded-full text-white font-bold bg-gradient-to-r from-amber-500 to-rose-500 shadow ring-2 ring-amber-300/40">
            <i class="fa-solid fa-star mr-1"></i> <span id="top-lukas">0</span> Lukas
          </div>
        </div>

        <!-- Notifs -->
        <div id="notif-wrap" class="hidden relative">
          <button id="notif-btn" class="relative p-2 text-gray-600 hover:text-gray-900">
            <i class="fa-solid fa-bell text-lg"></i>
            <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">3</span>
          </button>
          <div id="notif-menu" class="hidden absolute right-0 mt-2 w-80 bg-white border rounded-lg shadow-lg z-50">
            <div class="px-3 py-2 text-xs text-gray-500">Notifications</div>
            <div class="max-h-64 overflow-auto divide-y">
              <div class="p-3 text-sm"><b>Bonus active</b>: Sponsor multiplier x1.5 on today‚Äôs match</div>
              <div class="p-3 text-sm">Weekly reset in <b>2d 4h</b></div>
              <div class="p-3 text-sm">You earned <b>+8 Lukas</b> yesterday</div>
            </div>
          </div>
        </div>

        <!-- Auth buttons -->
        <div id="auth-buttons" class="flex items-center space-x-2">
          <button id="btn-open-signin" class="px-3 py-1.5 border rounded-lg text-sm text-gray-700 hover:bg-gray-100">Sign in</button>
          <button id="btn-open-signup" class="px-3 py-1.5 bg-primary text-white rounded-lg text-sm hover:bg-emerald-600">Create account</button>
        </div>

        <!-- Avatar -->
        <div id="avatar-menu" class="hidden relative">
          <button id="avatar-btn" class="flex items-center space-x-2 p-1 rounded-lg hover:bg-gray-100">
            <img src="https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-2.jpg" class="w-8 h-8 rounded-full" alt="avatar">
            <i class="fa-solid fa-chevron-down text-gray-400 text-xs"></i>
          </button>
          <div id="avatar-dropdown" class="hidden absolute right-0 mt-2 w-44 bg-white border rounded-lg shadow-lg z-50">
            <button id="dd-account" class="w-full text-left block px-4 py-2 text-sm hover:bg-gray-50">Account</button>
            <button id="dd-terms" class="w-full text-left block px-4 py-2 text-sm hover:bg-gray-50">Terms & Conditions</button>
            <button id="dd-logout" class="w-full text-left block px-4 py-2 text-sm text-red-600 hover:bg-red-50">Log Out</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="pt-20 pb-20">
    <div class="max-w-7xl mx-auto px-4">

      <!-- MATCHES (home) -->
      <section id="matches-section" class="transition-all">
        <!-- HERO -->
        <div class="mb-4 grid grid-cols-1 lg:grid-cols-[1.1fr_.9fr] gap-4">
          <div class="bg-gradient-to-r from-emerald-600 to-emerald-500 rounded-2xl p-6 text-white">
            <div class="flex items-center justify-between">
              <div>
                <h1 class="text-2xl font-extrabold">Mis combinadas de hoy</h1>
                <p id="hero-personal-sub" class="text-emerald-100">Inicia sesi√≥n para crear y seguir tus propias combinadas.</p>
              </div>
              <div class="hidden sm:block bg-white/10 rounded-xl px-4 py-2 text-sm font-semibold">
                <i class="fa-solid fa-bolt-lightning mr-1"></i><span id="hero-bonus">Bonus active</span>
              </div>
            </div>
            <div class="mt-4 flex flex-wrap gap-2 text-sm">
              <span class="bg-white/10 px-3 py-1 rounded-full">üî• Tus partidos por jugar</span>
              <span class="bg-white/10 px-3 py-1 rounded-full">üéØ Seguimiento de picks personales</span>
              <span class="bg-white/10 px-3 py-1 rounded-full">üèÜ Progreso rumbo a premios</span>
            </div>
          </div>

          <div class="bg-white rounded-2xl border p-5">
            <div class="flex items-center justify-between">
              <div class="font-semibold text-gray-900">Mi progreso</div>
              <div class="text-xs text-gray-500">Personaliza tu camino a premios</div>
            </div>
            <div class="mt-3 grid grid-cols-3 gap-3 text-center">
              <div class="p-3 rounded-lg bg-emerald-50 border">
                <div class="text-emerald-700 text-xl font-extrabold" id="hero-streak">2</div>
                <div class="text-xs text-emerald-700">Racha de d√≠as</div>
              </div>
              <div class="p-3 rounded-lg bg-yellow-50 border">
                <div class="text-amber-700 text-xl font-extrabold">x1.5</div>
                <div class="text-xs text-amber-700">Multiplicador activo</div>
              </div>
              <div class="p-3 rounded-lg bg-sky-50 border">
                <div class="text-sky-700 text-xl font-extrabold" id="hero-players">0</div>
                <div class="text-xs text-sky-700">Mis combinadas activas</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Lista de partidos -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-gray-900">Upcoming tournaments</h2>
            <div class="text-sm text-gray-600"><i class="fa-regular fa-calendar mr-1"></i>Sorted by time to kickoff</div>
          </div>
          <div id="matches-vertical" class="space-y-5"></div>
        </div>
      </section>

      <!-- RESULTS / FOLLOW LIVE -->
      <section id="results-section" class="hidden transition-all">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <div class="flex items-center justify-between">
            <h1 class="text-2xl font-bold text-gray-900">Results / Follow Live!</h1>
            <div class="text-sm text-gray-600 flex items-center gap-2">
              <i class="fa-solid fa-satellite-dish"></i> Live, upcoming and finished
            </div>
          </div>

          <div id="attention-banner" class="mt-4 p-4 rounded-xl bg-gradient-to-r from-emerald-50 to-green-50 border border-emerald-200/60 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="text-2xl">üî•</span>
              <div class="text-sm">
                <div id="banner-title" class="font-semibold text-gray-900">Hot match</div>
                <div id="banner-sub" class="text-gray-600">Join before kickoff and boost with sponsor bonus</div>
              </div>
            </div>
            <div class="flex items-center gap-3">
              <div id="banner-bonus" class="text-xs font-semibold px-2 py-1 rounded-full bg-amber-100 text-amber-800 hidden"></div>
              <button id="banner-cta" class="px-3 py-1.5 bg-primary text-white rounded-lg text-sm hover:bg-emerald-600">Make your picks</button>
            </div>
          </div>

          <div id="live-block" class="mt-6 hidden">
            <div class="flex items-center gap-2 mb-2">
              <span class="w-2 h-2 rounded-full bg-red-600 animate-pulse"></span>
              <h3 class="text-sm font-semibold text-red-600">Live now</h3>
            </div>
            <div id="live-table"></div>
          </div>

          <div class="mt-8">
            <h3 class="text-sm font-semibold text-gray-900 mb-2">All Matches</h3>
            <div id="all-table"></div>
          </div>
        </div>
      </section>
	  <!-- REWARDS / REDEEM STORE -->
	  <section id="rewards-section" class="transition-all">
	    <!-- HEADER / BALANCE -->
	    <div class="mb-4 grid grid-cols-1 lg:grid-cols-[1.1fr_.9fr] gap-4">
	      <div class="bg-gradient-to-r from-amber-500 to-rose-500 text-white rounded-2xl p-6 shadow">
	        <div class="flex items-center justify-between">
	          <div>
	            <div class="text-sm opacity-90">Your Lukas balance</div>
	            <div id="rewards-balance" class="text-4xl font-extrabold leading-tight">0 Lukas</div>
	            <div class="text-xs opacity-90 mt-1">Earn Lukas in matches and redeem here.</div>
	          </div>
	          <div class="text-right">
	            <div class="text-xs opacity-90">Current streak</div>
	            <div id="rewards-streak" class="text-2xl font-extrabold">0</div>
	            <div class="mt-2 flex gap-2 justify-end">
	              <button id="rewards-cta-matches" class="px-4 py-2 border rounded-lg text-sm bg-white/10 hover:bg-white/20">Go to Matches</button>
	              <button id="open-orders" class="px-4 py-2 bg-white text-rose-600 rounded-lg font-semibold text-sm hover:bg-rose-50">
	                My orders
	              </button>
	            </div>
	          </div>
	        </div>
	        <div class="grid grid-cols-3 gap-3 mt-5 text-center">
	          <div class="bg-white/15 rounded-lg py-3">
	            <div id="rw-lifetime" class="text-xl font-bold">‚Äî</div>
	            <div class="text-xs">Lifetime Lukas</div>
	          </div>
	          <div class="bg-white/15 rounded-lg py-3">
	            <div id="rw-tickets" class="text-xl font-bold">‚Äî</div>
	            <div class="text-xs">Tickets played</div>
	          </div>
	          <div class="bg-white/15 rounded-lg py-3">
	            <div id="rw-avg" class="text-xl font-bold">‚Äî</div>
	            <div class="text-xs">Avg. rank</div>
	          </div>
	        </div>
	      </div>
	
	      <!-- HOW IT WORKS -->
	      <div class="bg-white rounded-2xl border p-6">
	        <h3 class="text-lg font-bold text-gray-900">How redemptions work</h3>
	        <ol class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3">
	          <li class="flex items-start gap-3 p-3 rounded-lg border bg-emerald-50/60">
	            <div class="w-8 h-8 rounded-full bg-emerald-600 text-white flex items-center justify-center"><i class="fa-solid fa-pen"></i></div>
	            <div class="text-sm"><b>Play & earn Lukas</b><br><span class="text-gray-600">Compete daily and collect Lukas.</span></div>
	          </li>
	          <li class="flex items-start gap-3 p-3 rounded-lg border bg-yellow-50/60">
	            <div class="w-8 h-8 rounded-full bg-amber-500 text-white flex items-center justify-center"><i class="fa-solid fa-store"></i></div>
	            <div class="text-sm"><b>Choose a reward</b><br><span class="text-gray-600">Electronics, gift cards and more.</span></div>
	          </li>
	          <li class="flex items-start gap-3 p-3 rounded-lg border bg-sky-50/60">
	            <div class="w-8 h-8 rounded-full bg-sky-500 text-white flex items-center justify-center"><i class="fa-solid fa-shield-check"></i></div>
	            <div class="text-sm"><b>Redeem securely</b><br><span class="text-gray-600">ID/age checks, shipping & tracking.</span></div>
	          </li>
	        </ol>
	      </div>
	    </div>
	
	    <!-- FILTERS -->
	    <div class="bg-white rounded-2xl border p-4 mb-3">
	      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
	        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 flex-1">
	          <div>
	            <label class="text-xs text-gray-600">Category</label>
	            <select id="flt-category" class="w-full border rounded-lg px-3 py-2 mt-1">
	              <option value="">All</option>
	              <option value="phones">Phones</option>
	              <option value="laptops">Laptops</option>
	              <option value="consoles">Consoles</option>
	              <option value="giftcards">Gift cards</option>
	              <option value="accessories">Accessories</option>
	            </select>
	          </div>
	          <div>
	            <label class="text-xs text-gray-600">Sort</label>
	            <select id="flt-sort" class="w-full border rounded-lg px-3 py-2 mt-1">
	              <option value="popular">Most popular</option>
	              <option value="low">Cost: Low ‚Üí High</option>
	              <option value="high">Cost: High ‚Üí Low</option>
	              <option value="new">Newest</option>
	            </select>
	          </div>
	          <div>
	            <label class="text-xs text-gray-600">Max Lukas</label>
	            <input id="flt-max" type="number" min="0" class="w-full border rounded-lg px-3 py-2 mt-1" placeholder="e.g. 1200">
	          </div>
	          <div>
	            <label class="text-xs text-gray-600">Search</label>
	            <input id="flt-q" class="w-full border rounded-lg px-3 py-2 mt-1" placeholder="iPhone, PS5‚Ä¶">
	          </div>
	        </div>
	        <div class="flex gap-2">
	          <button id="flt-clear" class="px-3 py-2 border rounded-lg text-sm hover:bg-gray-50">Clear</button>
	          <span class="text-xs text-gray-500 self-center" id="store-count">‚Äî items</span>
	        </div>
	      </div>
	    </div>
	
	    <!-- STORE GRID -->
	    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="store-grid"></div>
	
	    <!-- INFO CARDS -->
	    <div class="grid md:grid-cols-3 gap-4 mt-4">
	      <div class="bg-white rounded-xl border p-4">
	        <h4 class="text-sm font-semibold mb-2">Redemption policy</h4>
	        <ul class="text-xs text-gray-700 space-y-1">
	          <li>‚Ä¢ One account per person. 18+ only.</li>
	          <li>‚Ä¢ Govt. ID and email verification required.</li>
	          <li>‚Ä¢ Processing time: 1‚Äì3 business days (gift cards instant).</li>
	          <li>‚Ä¢ Limited quantities, while supplies last.</li>
	        </ul>
	      </div>
	      <div class="bg-white rounded-xl border p-4">
	        <h4 class="text-sm font-semibold mb-2">Shipping & delivery</h4>
	        <ul class="text-xs text-gray-700 space-y-1">
	          <li>‚Ä¢ Peru nationwide shipping (electronics).</li>
	          <li>‚Ä¢ Digital rewards delivered by email.</li>
	          <li>‚Ä¢ Tracking provided once shipped.</li>
	        </ul>
	      </div>
	      <div class="bg-white rounded-xl border p-4">
	        <h4 class="text-sm font-semibold mb-2">Help</h4>
	        <ul class="text-xs text-gray-700 space-y-1">
	          <li>‚Ä¢ Keep your email verified and profile complete.</li>
	          <li>‚Ä¢ Mismatched names or addresses may delay delivery.</li>
	          <li>‚Ä¢ Contact support with your Order ID.</li>
	        </ul>
	      </div>
	    </div>
	  </section>

      <!-- ADD: ACCOUNT PAGE -->
      <section id="account-section" class="hidden transition-all">
        <div class="bg-white rounded-2xl border p-6 mb-4">
		  <div class="flex items-start justify-between gap-4">
		    <div>
		      <h1 class="text-2xl font-bold">Account</h1>
		      <p class="text-sm text-gray-600">Manage your profile.</p>
		    </div>
		    <div class="flex items-center gap-2">
		      <button id="acc-edit" class="px-3 py-1.5 border rounded-lg text-sm">Edit</button>
		      <button id="acc-cancel" class="px-3 py-1.5 border rounded-lg text-sm hidden">Cancel</button>
		      <!-- Nuevo bot√≥n Save arriba -->
		      <button id="acc-save-top" class="px-3 py-1.5 bg-primary text-white rounded-lg text-sm font-semibold disabled:opacity-40 disabled:cursor-not-allowed hidden">
		        Save changes
		      </button>
		    </div>
		  </div>
		</div>
        <!-- ADD: gate para usuarios no logueados -->
        <div id="account-guest" class="bg-white rounded-2xl border p-6 mb-4 hidden">
          <h2 class="text-lg font-semibold">Please sign in</h2>
          <p class="text-sm text-gray-600">You need an account to manage your settings.</p>
          <div class="mt-3 flex gap-2">
            <button id="acc-open-signin" class="px-3 py-1.5 border rounded-lg text-sm">Sign in</button>
            <button id="acc-open-signup" class="px-3 py-1.5 bg-primary text-white rounded-lg text-sm">Create account</button>
          </div>
        </div>
          
        <div id="account-body" class="space-y-4">
          <!-- Profile -->
		  <div class="bg-white rounded-2xl border p-6">
		    <h2 class="text-lg font-semibold mb-4">Profile</h2>
		
		    <!-- Username (solo lectura, viene de auth.user.user_metadata.username) -->
		    <div class="grid sm:grid-cols-2 gap-3">
		      <div>
		        <label class="text-xs text-gray-600">Username</label>
		        <input id="acc-username" type="text" class="w-full border rounded-lg px-3 py-2 mt-1 bg-gray-50"
		               placeholder="Your username" disabled>
		        <p class="text-[11px] text-gray-500 mt-1">
		          Se define al crear la cuenta. (Editable en futuras versiones)
		        </p>
		      </div>
		    </div>
		
		    <div class="flex items-center gap-4 mt-4">
		      <img id="acc-avatar" class="w-16 h-16 rounded-full border" src="" alt="avatar">
		      <button id="acc-change-avatar" class="px-3 py-1.5 border rounded-lg text-sm">Choose from library</button>
		    </div>
		
		    <div class="grid sm:grid-cols-2 gap-3 mt-4">
		      <div>
		        <label class="text-xs text-gray-600">Real name</label>
		        <input id="acc-fullname" type="text" class="w-full border rounded-lg px-3 py-2 mt-1" placeholder="Your real name">
		        <p class="text-[11px] text-gray-500 mt-1">Nombre real, visible para otros jugadores.</p>
		      </div>
		      <div>
		        <label class="text-xs text-gray-600">Favorite team</label>
		        <select id="acc-team" class="w-full border rounded-lg px-3 py-2 mt-1">
		          <option>Real Madrid</option><option>Barcelona</option><option>Man City</option>
		          <option>Arsenal</option><option>Alianza Lima</option><option>Universitario</option>
		        </select>
		      </div>
		    </div>
		  </div>

          <!-- Identity & Age -->
          <div class="bg-white rounded-2xl border p-6">
            <h2 class="text-lg font-semibold mb-4">Identity & Age (18+)</h2>
            <div class="grid sm:grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-gray-600">Date of birth</label>
                <input id="acc-dob" type="date" class="w-full border rounded-lg px-3 py-2 mt-1">
              </div>
              <div class="flex items-end">
                <label class="flex items-center gap-2 text-sm">
                  <input id="acc-18" type="checkbox" class="accent-primary">
                  I confirm I am 18+ years old
                </label>
              </div>
            </div>
            <div id="acc-age-error" class="hidden mt-2 text-sm text-red-600 bg-red-50 border border-red-200 rounded p-2">
              Only adults (18+) can play on Habla!.
            </div>
          </div>

		  <!-- Account & Security -->
		  <div class="bg-white rounded-2xl border p-6">
		    <h2 class="text-lg font-semibold mb-4">Account & Security</h2>
		    <div class="grid sm:grid-cols-3 gap-3">
		      <div>
		        <label class="text-xs text-gray-600">Email</label>
		        <input id="acc-email" type="email"
		               class="w-full border rounded-lg px-3 py-2 mt-1"
		               placeholder="you@email.com">
		        <div class="mt-2 flex items-center gap-2">
		          <span id="acc-email-status" class="status-pill bg-gray-100 text-gray-700">
		            <span class="status-dot bg-gray-500"></span>
		            Checking‚Ä¶
		          </span>
		          <button id="acc-email-resend" class="text-xs text-primary underline hidden">
		            Resend verification
		          </button>
		        </div>
		        <p class="text-[11px] text-gray-500 mt-1">If you change your email, we‚Äôll send a new verification link.</p>
		      </div>
		
		      <div>
		        <label class="text-xs text-gray-600">New password</label>
		        <input id="acc-pass" type="password" class="w-full border rounded-lg px-3 py-2 mt-1" placeholder="Leave blank to keep">
		      </div>
		
		      <!-- columna 3 queda vac√≠a a prop√≥sito para balancear layout -->
		      <div class="hidden sm:block"></div>
		    </div>
		  </div>
        </div>
      </section>

    </div>
  </main>

  <!-- Overlay compartido -->
  <div id="overlay" class="fixed left-0 right-0 bottom-0 top-16 bg-black/40 backdrop-blur-[2px] opacity-0 pointer-events-none transition-opacity z-40"></div>

  <!-- Drawer: Ticket -->
  <aside id="ticket-drawer" class="fixed right-0 top-16 bottom-0 bg-white shadow-2xl border-l border-gray-200 z-50 w-[min(94vw,1200px)] translate-x-full transition-transform">
    <div class="flex items-center justify-between px-5 py-4 border-b">
      <button id="drawer-back" class="text-gray-700 hover:text-gray-900 flex items-center gap-2">
        <i class="fa-solid fa-arrow-left"></i><span class="text-sm font-medium">Back to matches</span>
      </button>
      <span id="ticket-lock-time" class="text-xs text-gray-500"></span>
    </div>

    <!-- OJO: a√±adimos pb-40 para no cortar el CTA al fondo -->
    <div class="h-full overflow-auto pb-40">
      <div class="max-w-6xl mx-auto px-5 py-5 grid grid-cols-1 lg:grid-cols-[1fr_340px] gap-6">
        <div>
          <div id="strip-ticket" class="strip shadow mb-4"></div>
          <div id="predictions-grid" class="space-y-4"></div>
          <div class="mt-6 p-4 border rounded-lg bg-gray-50">
            <div id="error-banner" class="hidden mb-3 p-3 rounded-md bg-red-50 border border-red-200 text-sm text-red-700">
              Please complete all 5 predictions before submitting.
            </div>
            <div class="grid grid-cols-3 gap-4 text-center">
              <div><div id="completed-counter" class="text-xl font-bold text-primary">0/5</div><div class="text-xs text-gray-600">Completed</div></div>
              <div><div id="time-remaining" class="text-xl font-bold text-red-600">--:--:--</div><div class="text-xs text-gray-600">Time to kickoff</div></div>
              <div><div id="lukas-balance" class="text-xl font-bold text-accent">‚Äî</div><div class="text-xs text-gray-600">If you win you will have</div></div>
            </div>
            <button id="submit-ticket" class="mt-4 w-full bg-gradient-to-r from-primary to-green-600 text-white font-bold py-3 rounded-lg text-base hover:from-green-600 hover:to-green-700">
              <i class="fa-solid fa-ticket mr-2"></i>Submit Tournament Ticket
            </button>
          </div>
        </div>
        <div class="space-y-6">
          <div class="border rounded-lg p-4">
            <div class="flex items-center gap-2">
              <img id="sponsor-logo" src="https://dummyimage.com/28x28/000/fff&text=S" class="w-7 h-7 rounded" alt="sponsor">
              <div><div class="text-sm font-semibold text-gray-900">Sponsored power-up</div><div id="sponsor-name" class="text-xs text-gray-500">by Sponsor</div></div>
            </div>
            <div id="bonus-list" class="mt-3 space-y-2"></div>
            <div class="mt-2 text-[11px] text-gray-500">Bonuses are applied automatically on this match.</div>
          </div>
          <div class="border rounded-lg p-4">
            <h3 class="text-sm font-semibold text-gray-900 mb-3">Match stats</h3>
            <div id="stat-probs" class="space-y-3"></div>
            <div class="mt-3 grid grid-cols-2 gap-3 text-xs">
              <div class="p-2 bg-gray-50 rounded"><div class="text-gray-500">Avg goals</div><div id="stat-avg" class="font-semibold">‚Äî</div></div>
              <div class="p-2 bg-gray-50 rounded"><div class="text-gray-500">Recent form</div><div id="stat-form" class="font-semibold leading-tight">‚Äî</div></div>
            </div>
          </div>
          <div class="border rounded-lg p-4">
            <div class="text-xs text-gray-500">Kickoff in</div>
            <div id="sidebar-clock" class="text-2xl font-bold text-red-600">--:--:--</div>
          </div>
        </div>
      </div>
    </div>
  </aside>

  <!-- Drawer: Results -->
  <aside id="results-drawer" class="fixed right-0 top-16 bottom-0 bg-white shadow-2xl border-l border-gray-200 z-50 w-[min(95vw,1200px)] translate-x-full transition-transform">
    <div class="flex items-center justify-between px-5 py-4 border-b">
      <button id="results-back" class="text-gray-700 hover:text-gray-900 flex items-center gap-2">
        <i class="fa-solid fa-arrow-left"></i><span class="text-sm font-medium">Back to Results</span>
      </button>
      <span id="results-status-pill" class="text-xs font-semibold px-2 py-1 rounded-full"></span>
    </div>
    <div class="h-full overflow-auto">
      <div class="max-w-6xl mx-auto px-5 py-5 grid grid-cols-1 lg:grid-cols-[1fr_360px] gap-6">
        <div>
          <div id="results-strip" class="strip shadow mb-4"></div>
          <div class="border rounded-lg">
            <div class="px-4 py-3 border-b flex items-center justify-between">
              <h3 class="text-lg font-semibold">Participants</h3>
              <div id="participants-count" class="text-sm text-gray-600">‚Äî</div>
            </div>
            <div id="players-list" class="divide-y"></div>
          </div>
        </div>
                <div class="space-y-6">
                  <!-- Status / reloj -->
                  <div id="results-panel-status" class="border rounded-lg p-4">
                    <div class="text-xs text-gray-500" id="live-time-label">Status</div>
                    <div id="live-time" class="text-2xl font-bold">‚Äî</div>
                    <div id="live-score" class="mt-1 text-sm text-gray-700"></div>
                  </div>

                  <!-- Leyenda de predicciones -->
                  <div id="results-panel-legend" class="border rounded-lg p-4">
                    <h4 class="text-sm font-semibold mb-2">Leyenda de predicciones</h4>
                    <ul class="text-xs text-gray-700 space-y-1" id="pred-legend">
                      <li>‚Ä¢ <b>P1</b>: Resultado del partido ‚Äî <i>HOME</i> / <i>DRAW</i> / <i>AWAY</i></li>
		      <li>‚Ä¢ <b>P2</b>: Ambos anotan ‚Äî <i>YES / NO</i></li>
		      <li>‚Ä¢ <b>P3</b>: Total goles ‚Äî <i>OVER 2.5 / UNDER 2.5</i></li>
		      <li>‚Ä¢ <b>P4</b>: ¬øTarjeta roja? ‚Äî <i>YES / NO</i></li>
		      <li>‚Ä¢ <b>P5</b>: Marcador exacto ‚Äî <i>Ej.: 2-1</i></li>
		    </ul>
                  </div>

                  <!-- Distribuci√≥n de respuestas -->
                  <div id="results-panel-distribution" class="border rounded-lg p-4">
                    <h4 class="text-sm font-semibold mb-3">Distribuci√≥n de respuestas</h4>

                    <div class="mb-2 text-xs text-gray-600 font-medium">P1 ¬∑ 1X2</div>
		    <div id="dist-p1" class="dist-bar bg-gray-200 mb-2"></div>
		    <div class="flex justify-between text-[11px] text-gray-600 mb-3"><span>Home</span><span>Draw</span><span>Away</span></div>
		
		    <div class="mb-2 text-xs text-gray-600 font-medium">P2 ¬∑ BTTS</div>
		    <div id="dist-p2" class="dist-bar bg-gray-200 mb-2"></div>
		    <div class="flex justify-between text-[11px] text-gray-600 mb-3"><span>Yes</span><span>No</span></div>
		
		    <div class="mb-2 text-xs text-gray-600 font-medium">P3 ¬∑ Over/Under 2.5</div>
		    <div id="dist-p3" class="dist-bar bg-gray-200 mb-2"></div>
		    <div class="flex justify-between text-[11px] text-gray-600 mb-3"><span>Over</span><span>Under</span></div>
		
		    <div class="mb-2 text-xs text-gray-600 font-medium">P4 ¬∑ Tarjeta roja</div>
		    <div id="dist-p4" class="dist-bar bg-gray-200 mb-2"></div>
		    <div class="flex justify-between text-[11px] text-gray-600 mb-3"><span>Yes</span><span>No</span></div>
		
		    <div class="mb-2 text-xs text-gray-600 font-medium">P5 ¬∑ Marcador exacto</div>
		    <div id="dist-p5" class="mt-1 space-y-1 text-[11px] text-gray-700"></div>
                  </div>

                  <!-- Pozo y premios -->
                  <div id="results-panel-pot" class="border rounded-lg p-4">
                    <h4 class="text-sm font-semibold mb-2">Pozo y premios</h4>
                    <div class="text-sm"><b>Pozo acumulado:</b> <span id="pot-amount">‚Äî</span></div>
                    <ul class="mt-2 text-sm text-gray-700" id="prize-breakdown">
		      <li>ü•á 1¬∫: <b id="prize-1">‚Äî</b> (50%)</li>
		      <li>ü•à 2¬∫: <b id="prize-2">‚Äî</b> (35%)</li>
		      <li>ü•â 3¬∫: <b id="prize-3">‚Äî</b> (15%)</li>
		    </ul>
		    <p class="mt-3 text-xs text-gray-600">
		      <b>Empates:</b> si hay empate en un puesto premiado, se reparte en partes iguales la suma de los premios de esos puestos. 
		      Ej.: si 2 empatan el 1¬∫, reciben por igual la suma del 50% y 35% del pozo.
		    </p>
                  </div>

                  <!-- (se mantiene el panel de Bonus si lo usas) -->
                  <div id="results-panel-bonus" class="border rounded-lg p-4">
                    <div class="flex items-center gap-2">
                      <img id="res-sponsor-logo" src="https://dummyimage.com/28x28/000/fff&text=S" class="w-7 h-7 rounded" alt="sponsor">
		      <div>
		        <div class="text-sm font-semibold text-gray-900">Bonuses</div>
		        <div id="res-sponsor-name" class="text-xs text-gray-500">by Sponsor</div>
		      </div>
		    </div>
		    <div id="res-bonus-list" class="mt-3 space-y-2"></div>
		  </div>
		</div>
      </div>
    </div>
  </aside>

  <!-- AUTH FLOW -->
  <div id="auth-flow" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-[70]">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
      <div id="auth-header" class="px-6 pt-8 pb-4 text-center">
        <div class="w-12 h-12 rounded-full bg-primary/90 text-white flex items-center justify-center mx-auto shadow"><i class="fa-solid fa-futbol"></i></div>
        <h2 class="mt-3 text-xl font-bold">Welcome to Habla!</h2>
        <p id="auth-subtitle" class="text-sm text-gray-600">Daily football predictions game</p>
      </div>
      <div class="px-6 border-t">
        <div class="flex items-center">
          <button data-tab="signin" class="auth-tab flex-1 py-3 text-sm font-medium border-b-2 border-primary text-primary">Sign In</button>
          <button data-tab="signup" class="auth-tab flex-1 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500">Sign Up</button>
          <button data-tab="reset" class="auth-tab flex-1 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500">Reset</button>
        </div>
      </div>
      <div class="px-6 py-5 space-y-5">
        <form id="form-signin" class="space-y-4">
          <div><label class="text-xs text-gray-600">Email</label><div class="mt-1 relative"><input id="si-email" type="email" class="w-full border rounded-lg px-3 py-2 pr-9" placeholder="Enter your email" required><i class="fa-regular fa-envelope absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i></div></div>
          <div><label class="text-xs text-gray-600">Password</label><div class="mt-1 relative"><input id="si-pass"  type="password" class="w-full border rounded-lg px-3 py-2 pr-9" placeholder="Enter your password" required><button type="button" data-toggle="#si-pass" class="toggle-pass absolute right-2 top-1/2 -translate-y-1/2 text-gray-400"><i class="fa-regular fa-eye"></i></button></div>
            <div class="flex items-center justify-between mt-2"><label class="text-xs text-gray-600 flex items-center gap-2"><input type="checkbox" class="accent-primary"> Remember me</label><button type="button" data-jump="reset" class="text-xs text-primary hover:underline">Forgot password?</button></div>
          </div>
          <button type="submit" class="w-full bg-primary text-white rounded-lg py-2.5 font-semibold">Sign In</button>
          <button id="btn-guest-signin" type="button" class="w-full bg-gray-100 text-gray-800 rounded-lg py-2.5 font-semibold flex items-center justify-center gap-2">
            <i class="fa-regular fa-user"></i> Continue as Guest
          </button>
          <p class="text-[11px] text-gray-500 text-center">By signing in, you agree to our <a class="underline">Terms</a> and <a class="underline">Privacy Policy</a>.</p>
        </form>
		  
		<form id="form-signup" class="space-y-4">
		  <div>
		    <label class="text-xs text-gray-600">Username</label>
		    <div class="mt-1 relative">
		      <input id="su-username" type="text"
		             class="w-full border rounded-lg px-3 py-2 pr-9"
		             placeholder="Choose a username" required minlength="3" maxlength="20">
		      <i class="fa-regular fa-user absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
		    </div>
		    <p id="err-su-username" class="hidden text-[11px] text-red-600 mt-1">Username must be 3‚Äì20 characters.</p>
		  </div>
		
		  <div>
		    <label class="text-xs text-gray-600">Email Address</label>
		    <div class="mt-1 relative">
		      <input id="su-email" type="email"
		             class="w-full border rounded-lg px-3 py-2 pr-9"
		             placeholder="your@email.com" required>
		      <i class="fa-regular fa-envelope absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
		    </div>
		    <p id="err-su-email" class="hidden text-[11px] text-red-600 mt-1">Invalid email format.</p>
		  </div>
		
		  <div class="grid grid-cols-2 gap-3">
		    <div>
		      <label class="text-xs text-gray-600">Password</label>
		      <div class="mt-1 relative">
		        <input id="su-pass" type="password"
		               class="w-full border rounded-lg px-3 py-2 pr-9"
		               placeholder="Create a strong password" required>
		        <button type="button" data-toggle="#su-pass"
		                class="toggle-pass absolute right-2 top-1/2 -translate-y-1/2 text-gray-400">
		          <i class="fa-regular fa-eye"></i>
		        </button>
		      </div>
		      <p class="text-[11px] text-gray-500 mt-1">Min 8 chars, 1 number & 1 symbol.</p>
		      <p id="err-su-pass" class="hidden text-[11px] text-red-600 mt-1">Password is too weak.</p>
		    </div>
		    <div>
		      <label class="text-xs text-gray-600">Confirm Password</label>
		      <div class="mt-1 relative">
		        <input id="su-confirm" type="password"
		               class="w-full border rounded-lg px-3 py-2 pr-9"
		               placeholder="Confirm your password" required>
		        <button type="button" data-toggle="#su-confirm"
		                class="toggle-pass absolute right-2 top-1/2 -translate-y-1/2 text-gray-400">
		          <i class="fa-regular fa-eye"></i>
		        </button>
		      </div>
		      <p id="err-su-confirm" class="hidden text-[11px] text-red-600 mt-1">Passwords don‚Äôt match.</p>
		    </div>
		  </div>
		
		  <label class="text-xs text-gray-600 flex items-center gap-2">
		    <input id="su-terms" type="checkbox" required class="accent-primary">
		    I agree to the <a class="underline">Terms of Service</a> and <a class="underline">Privacy Policy</a>
		  </label>
		  <p id="err-su-terms" class="hidden text-[11px] text-red-600">Please accept the Terms & Privacy.</p>
		
		  <!-- Banner de verificaci√≥n + reenviar -->
		  <div id="su-verify-banner"
		       class="hidden bg-blue-50 border border-blue-200 rounded-lg px-3 py-2 text-sm text-blue-800">
		    <b>Check your email</b> ‚Äì We sent a verification link.
		    <button id="su-resend" type="button" class="ml-2 text-blue-700 underline">Resend</button>
		  </div>
		
		  <button id="su-submit" type="submit"
		          class="w-full bg-primary text-white rounded-lg py-2.5 font-semibold flex items-center justify-center gap-2">
		    <i class="fa-solid fa-user-plus"></i> <span>Create Account</span>
		    <i id="su-spinner" class="hidden fa-solid fa-spinner animate-spin"></i>
		  </button>
		
		  <button id="btn-guest-signup" type="button"
		          class="w-full bg-gray-100 text-gray-800 rounded-lg py-2.5 font-semibold flex items-center justify-center gap-2">
		    <i class="fa-regular fa-user"></i> Continue as Guest
		  </button>
		
		  <p class="text-[11px] text-gray-500 text-center">
		    Already have an account?
		    <button type="button" data-jump="signin" class="text-primary underline">Sign in here</button>
		  </p>
		</form>
		<form id="form-reset" class="space-y-4 hidden">
		  <div>
		    <label class="text-xs text-gray-600">Email</label>
		    <div class="mt-1 relative">
		      <input id="re-email" type="email"
		             class="w-full border rounded-lg px-3 py-2 pr-9"
		             placeholder="Enter your email" required>
		      <i class="fa-regular fa-envelope absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
		    </div>
		  </div>
		  <button type="submit" class="w-full bg-primary text-white rounded-lg py-2.5 font-semibold">
		    Send reset link
		  </button>
		</form>
      </div>
    </div>
  </div>

  <!--  -->
  <div id="review-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-[65]">
    <div class="bg-white rounded-xl p-6 w-full max-w-lg shadow-xl">
      <h3 class="text-lg font-semibold mb-3">Review your picks</h3>
      <div id="review-list" class="mb-4 text-sm text-gray-800 space-y-2"></div>
      <div class="flex gap-3">
        <button id="confirm-submit" class="flex-1 bg-primary text-white px-4 py-2 rounded-lg hover:bg-emerald-600">
          Submit ticket
        </button>
        <button id="cancel-submit" class="flex-1 border px-4 py-2 rounded-lg hover:bg-gray-50">
          Go back
        </button>
      </div>
    </div>
  </div>

  <!-- NUEVO: Modal de √©xito -->
  <div id="success-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-[66]">
    <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-xl text-center">
      <div class="w-12 h-12 rounded-full bg-emerald-500 text-white flex items-center justify-center mx-auto">
        <i class="fa-solid fa-check"></i>
      </div>
      <h3 class="text-lg font-semibold mt-3">Ticket submitted!</h3>
      <p id="success-desc" class="text-sm text-gray-600 mt-1">
        Your predictions were saved successfully.
      </p>
      <div class="mt-4 flex gap-2">
        <button id="success-goto-results" class="flex-1 bg-secondary text-white rounded-lg py-2 text-sm hover:bg-blue-600">
          Follow Live / Results
        </button>
        <button id="success-close" class="flex-1 border rounded-lg py-2 text-sm">
          Close
        </button>
      </div>
    </div>
  </div>
  <!-- Signup complete / verify email -->
  <div id="signup-complete-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-[95]">
    <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-xl text-center">
      <div class="w-12 h-12 rounded-full bg-emerald-500 text-white flex items-center justify-center mx-auto">
        <i class="fa-solid fa-check"></i>
      </div>
      <h3 class="text-lg font-semibold mt-3">¬°Registro completado!</h3>
      <p class="text-sm text-gray-600 mt-1">
        Te enviamos un correo con el enlace de verificaci√≥n. Por favor, rev√≠salo para activar tu cuenta.
      </p>
      <div id="sc-email-hint" class="text-xs text-gray-500 mt-2"></div>

      <div class="mt-4 flex gap-2">
        <button id="sc-resend" class="flex-1 border rounded-lg py-2 text-sm hover:bg-gray-50">
          Reenviar email
        </button>
        <button id="sc-continue" class="flex-1 bg-primary text-white rounded-lg py-2 text-sm font-semibold">
          Continuar
        </button>
      </div>
    </div>
  </div>
  <!-- ADD: Avatar library modal -->
  <div id="avatar-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-[90]">
    <div class="bg-white rounded-2xl w-full max-w-2xl p-6 shadow-xl">
      <h3 class="text-lg font-semibold">Choose an avatar</h3>
      <p class="text-sm text-gray-600">Pick one from our approved library.</p>
      <div id="avatar-grid" class="grid grid-cols-6 gap-3 mt-4"></div>
      <div class="mt-4 text-right">
        <button id="avatar-cancel" class="px-4 py-2 border rounded-lg">Close</button>
      </div>
    </div>
  </div>
    <div id="terms-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-[80]">
    <div class="bg-white rounded-2xl w-full max-w-2xl p-6 shadow-xl">
      <h3 class="text-lg font-semibold">Terms & Conditions</h3>
      <div class="mt-3 max-h-[60vh] overflow-auto text-sm text-gray-700 space-y-2">
        <p>These are placeholder Terms & Conditions for demo purposes.</p>
        <p>You can replace this text with your real T&amp;C content.</p>
      </div>
      <div class="mt-4 text-right">
        <button id="terms-close" class="px-4 py-2 border rounded-lg">Close</button>
      </div>
    </div>
  </div>
  <div id="toast" class="fixed bottom-6 right-6 hidden">
    <div class="bg-gray-900 text-white px-4 py-3 rounded-lg shadow-lg flex items-center space-x-2">
      <i class="fa-solid fa-check-circle"></i><span id="toast-text">Done!</span>
    </div>
  </div>
  <div id="profile-wizard" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-[80]">
    <div class="bg-white rounded-2xl w-full max-w-xl p-6 shadow-2xl">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Complete your profile</h3>
      </div>
      <p class="text-sm text-gray-600 mt-1">A few details to get you started.</p>
      <!-- Todo en una sola vista scrolleable -->
      <div id="pw-form" class="mt-4 max-h-[60vh] overflow-y-auto space-y-5 pr-1">
        <!-- Nombre + Equipo -->
        <div class="space-y-3">
          <div>
            <label class="text-xs text-gray-600">Real name</label>
            <input id="pw-fullname" class="w-full border rounded-lg px-3 py-2 mt-1" placeholder="Your real name">
            <p id="err-pw-fullname" class="hidden text-[11px] text-red-600 mt-1">Please enter your name.</p>
          </div>
          <div>
            <label class="text-xs text-gray-600">Favorite team</label>
            <select id="pw-team" class="w-full border rounded-lg px-3 py-2 mt-1">
              <option>Real Madrid</option><option>Barcelona</option><option>Man City</option>
              <option>Arsenal</option><option>Alianza Lima</option><option>Universitario</option>
            </select>
          </div>
        </div>

        <!-- Edad -->
        <div class="space-y-3">
          <div class="grid sm:grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-gray-600">Date of birth</label>
              <input id="pw-dob" type="date" class="w-full border rounded-lg px-3 py-2 mt-1">
            </div>
            <div class="flex items-end">
              <label class="flex items-center gap-2 text-sm">
                <input id="pw-18" type="checkbox" class="accent-primary">
                I confirm I am 18+ years old
              </label>
            </div>
          </div>
          <div id="pw-age-error" class="hidden mt-1 text-sm text-red-600 bg-red-50 border border-red-200 rounded p-2">
            Only adults (18+) can play on Habla!.
          </div>
        </div>

        <!-- Avatar + Preferencias -->
        <div class="space-y-3">
          <div class="flex items-center gap-4">
            <img id="pw-avatar" class="w-16 h-16 rounded-full border" src="https://i.pravatar.cc/120?img=7" alt="avatar">
            <button id="pw-change-avatar" class="px-3 py-1.5 border rounded-lg text-sm">Choose from library</button>
          </div>
          <div class="grid sm:grid-cols-2 gap-3">
            <div>
              <label class="text-xs text-gray-600">Language</label>
              <select id="pw-lang" class="w-full border rounded-lg px-3 py-2 mt-1">
                <option>Espa√±ol</option><option>English</option>
              </select>
            </div>
            <label class="flex items-center gap-2 text-sm">
              <input id="pw-n-email" type="checkbox" class="accent-primary" checked>
              Email updates
            </label>
          </div>
        </div>
      </div>

      <!-- Botones: s√≥lo Back + Finish -->
      <div class="mt-5 flex gap-2">
        <button id="pw-back" class="flex-1 border rounded-lg py-2">Back</button>
        <button id="pw-finish" class="flex-1 bg-primary text-white rounded-lg py-2 font-semibold disabled:opacity-40 disabled:cursor-not-allowed">
          Finish
        </button>
      </div>
    </div>
  </div>
  <div id="redeem-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-[85]">
    <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-xl">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Redeem Lukas</h3>
        <button id="redeem-close" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100" aria-label="Close">
          <i class="fa-solid fa-xmark text-gray-500"></i>
        </button>
      </div>
      <p class="text-sm text-gray-600 mt-1">Convert your Lukas to cash (1 Luka = 1 Sol).</p>
      <div class="mt-4 space-y-3">
        <div class="p-3 rounded-lg bg-gray-50 border">
          <div class="text-xs text-gray-600">Your balance</div>
          <div id="redeem-balance" class="text-xl font-bold">0 Lukas</div>
        </div>
        <div>
          <label class="text-xs text-gray-600">Amount to redeem (min 100)</label>
          <input id="redeem-amount" type="number" min="0"
                 class="w-full border rounded-lg px-3 py-2 mt-1" placeholder="100">
          <div id="redeem-error" class="hidden mt-2 text-sm text-red-600 bg-red-50 border border-red-200 rounded p-2"></div>
        </div>
        <div class="p-3 rounded-lg bg-emerald-50 border border-emerald-200">
          <div class="text-xs text-emerald-800">You will receive</div>
          <div id="redeem-soles" class="text-lg font-bold text-emerald-700">S/ 0</div>
        </div>
      </div>
      <div class="mt-4 flex gap-2">
        <button id="redeem-confirm" class="flex-1 bg-primary text-white rounded-lg py-2 text-sm font-semibold disabled:opacity-40 disabled:cursor-not-allowed">
          Confirm redeem
        </button>
        <button id="redeem-close-2" class="flex-1 border rounded-lg py-2 text-sm hover:bg-gray-50">
          Cancel
        </button>
      </div>
    </div>
  </div>
<script>
/* ===== AUTH / HEADER ===== */
let currentView = 'matches';
let returnView  = null;
// --- AUTH STATE (real) ---
let isGuest = false; // modo invitado: navegar s√≠, enviar ticket no
let currentUser = null; // objeto supabase user
let pendingSubmit = null;
	
async function initAuth() {
  // lee sesi√≥n actual
  const { data: { session } } = await sb.auth.getSession();
  currentUser = session?.user ?? null;

  // Respeta modo guest si ven√≠a de localStorage
  isGuest = JSON.parse(localStorage.getItem('habla_guest') || 'false');

  headerAuth();
  renderRewards();
  renderAccount();

  // suscribe a cambios de sesi√≥n
  // ‚Äî‚Äî‚Äî APLICAR PERFIL PENDIENTE TRAS LOGIN ‚Äî‚Äî‚Äî
  async function applyPendingProfileOnLogin() {
    try {
      const raw = localStorage.getItem('habla_pw_pending');
      if (!raw) return;
      const pending = JSON.parse(raw);
      if (!pending?.payload) return;
      if (!currentUser) return;
      // Upsert ahora que s√≠ hay auth.uid()
      const { error } = await sb.from('profiles').upsert({
        user_id: currentUser.id,
        ...pending.payload
      });
      if (!error) {
        try { await logOnboardingSubmission(currentUser.id, pending.payload); } catch {}
        localStorage.removeItem('habla_pw_pending');
        showToast('Perfil completado. ¬°Bienvenido!');
      }
    } catch {}
  }

  sb.auth.onAuthStateChange((_event, sess) => {
    currentUser = sess?.user ?? null;
    if (currentUser) {isGuest = false;}
    localStorage.setItem('habla_guest', JSON.stringify(isGuest));
    headerAuth();
    renderRewards();
    renderAccount();
    // ‚ñ∫ Si el user se autentic√≥ en mitad de un intento de env√≠o,
    // retomamos el flujo abriendo el review con sus picks preservados.
    if (currentUser && pendingSubmit?.matchId) {
      try {auth.close();} catch (_) {}
      // reabrimos el ticket, restauramos picks y abrimos el modal de confirmaci√≥n
      const { matchId, picksSnapshot } = pendingSubmit;
      pendingSubmit = null;
      openTicket(matchId);
      // restaurar picks (s1..s4)
      if (picksSnapshot) {picks = { ...picksSnapshot };
        // aplica estilos activos a los botones seg√∫n lo elegido
        Object.entries(picks).forEach(([key, val]) => {
          const btn = document.querySelector(`#predictions-grid button[data-s="${key}"][data-v="${val}"]`);
          if (btn) {
            // limpiar siblings
            btn.parentElement.querySelectorAll(`button[data-s="${key}"]`).forEach(x=>{
              x.classList.remove('!bg-primary','!text-white');
            });
            btn.classList.add('!bg-primary','!text-white');
          }
        });

        // restaurar marcador (s5)
        if (picks.s5) {
          const [h,a] = picks.s5.split('-').map(n=>parseInt(n,10)||0);
          score.home = h; score.away = a;
          syncScore();
        }
        updateCompleted();
      }

      // si ya est√°n completas las 5, muestra el review directamente
      if (Object.keys(picks).length === 5) {
        openReviewModal();
      }
    }
	if (sess?.user) { applyPendingProfileOnLogin(); }
  });
}
function isLoggedIn() { return !!currentUser; };  // toggle para probar
let lukasBalance=1250;
const tournamentLukasPrize=100;
let userStreak=7;      // d√≠as
function headerAuth(){
  const show=(id,cond)=>document.getElementById(id).classList.toggle('hidden',!cond);
  show('auth-buttons',!isLoggedIn());
  show('avatar-menu', isLoggedIn());
  show('status-cluster', isLoggedIn());
  show('notif-wrap',  isLoggedIn());
  document.getElementById('top-lukas').textContent=lukasBalance.toLocaleString();
};
document.getElementById('btn-open-signin').addEventListener('click',()=>openAuthFlow('signin'));
document.getElementById('btn-open-signup').addEventListener('click',()=>openAuthFlow('signup'));
document.getElementById('avatar-btn')?.addEventListener('click',(e)=>{e.stopPropagation();document.getElementById('avatar-dropdown').classList.toggle('hidden');});
document.getElementById('notif-btn')?.addEventListener('click',(e)=>{e.stopPropagation();document.getElementById('notif-menu').classList.toggle('hidden');});
document.addEventListener('click',()=>{document.getElementById('avatar-dropdown')?.classList.add('hidden');document.getElementById('notif-menu')?.classList.add('hidden');});
document.getElementById('dd-account')?.addEventListener('click', (e)=>{e.stopPropagation();document.getElementById('avatar-dropdown')?.classList.add('hidden');showView('account');});
function openTerms(){
  const m = document.getElementById('terms-modal');
  m.classList.remove('hidden'); m.classList.add('flex');
}
function closeTerms(){
  const m = document.getElementById('terms-modal');
  m.classList.add('hidden'); m.classList.remove('flex');
}
document.getElementById('dd-terms')?.addEventListener('click',(e)=>{e.stopPropagation();document.getElementById('avatar-dropdown')?.classList.add('hidden');openTerms();});
document.getElementById('terms-close')?.addEventListener('click', closeTerms);
document.getElementById('dd-logout')?.addEventListener('click', async (e)=>{e.stopPropagation();
  await sb.auth.signOut();isGuest = false;localStorage.removeItem('habla_guest');
  headerAuth(); renderRewards(); renderAccount();showView('matches'); showToast('Logged out');});

// ===== LIVE DATA (Supabase) =====

const matchTicketsCache = new Map();

function getMatchTickets(matchId) {
  const key = Number(matchId);
  return matchTicketsCache.get(key) || [];
}

function mapTicketRpcRowToUI(row) {
  return {
    ticketId: row.ticket_id,
    rank: row.rank,
    submittedAt: row.submitted_at,
    user: {
      id: row.user_id,
      name: row.full_name || row.username || 'Player',
      username: row.username,
      avatar: row.avatar_url || '',
    },
    picks: {
      s1: row.s1 || null,
      s2: row.s2 || null,
      s3: row.s3 || null,
      s4: row.s4 || null,
      s5: row.s5 || null,
    },
    liveScore: {
      score: row.score,
      updatedAt: row.score_updated_at,
      rank: row.rank,
    },
  };
}

let matches = [];

function setMatchTickets(matchId, tickets) {
  const key = Number(matchId);
  matchTicketsCache.set(key, tickets);
  const idx = matches.findIndex(m => Number(m.id) === key);
  if (idx >= 0) {
    matches[idx] = { ...matches[idx], tickets };
  }
}

function resolveMatchTickets(match) {
  if (match && Array.isArray(match.tickets)) {
    return match.tickets;
  }
  return getMatchTickets(match?.id);
}

function getMyTickets(match) {
  const tickets = resolveMatchTickets(match);
  if (!Array.isArray(tickets) || !currentUser) {
    return [];
  }
  const userId = currentUser.id;
  return tickets.filter(ticket => ticket?.user?.id === userId);
}

async function hydrateMatchTickets(matchList = []) {
  if (!Array.isArray(matchList) || matchList.length === 0) {
    return;
  }

  const pending = matchList.filter(m => !matchTicketsCache.has(Number(m.id)));
  const groups = {
    LIVE: pending.filter(m => m.status === 'LIVE').map(m => m.id),
    NS: pending.filter(m => m.status === 'NS').map(m => m.id),
    FT: pending.filter(m => m.status === 'FT').map(m => m.id),
    OTHER: pending.filter(m => !['LIVE', 'NS', 'FT'].includes(m.status)).map(m => m.id),
  };

  const fetchForIds = async (ids) => {
    if (!ids || !ids.length) return;
    await Promise.all(ids.map(async (id) => {
      const { data, error } = await sb.rpc('get_match_tickets_with_picks', { p_match_id: id });
      if (error) {
        console.warn('[hydrateMatchTickets]', id, error);
        return;
      }
      const normalized = (data || []).map(mapTicketRpcRowToUI);
      setMatchTickets(id, normalized);
    }));
  };

  await fetchForIds(groups.LIVE);
  await fetchForIds(groups.NS);
  await fetchForIds(groups.FT);
  await fetchForIds(groups.OTHER);

  matchList.forEach((match, idx) => {
    const tickets = getMatchTickets(match.id);
    const updated = { ...match, tickets };
    const stateIdx = matches.findIndex(m => Number(m.id) === Number(match.id));
    if (stateIdx >= 0) {
      matches[stateIdx] = updated;
    }
    matchList[idx] = updated;
  });
}

// Mapea una fila de matches (DB) a la forma que usa tu UI
function mapMatchRowToUI(row) {
  return {
    id: row.id,
    league: row.league || '‚Äî',
    startISO: row.start_time,
    durMin: row.dur_min || 110,
    status: row.status,          // 'NS'|'LIVE'|'FT'
    score_home: row.score_home,
    score_away: row.score_away,
    live_minute: row.live_minute,
    lock_time: row.lock_time,
    home: { name: row.home_team, logo: '', color: 'bg-gray-700' },
    away: { name: row.away_team, logo: '', color: 'bg-gray-500' },
    sponsor: { name: 'Sponsor', logo: 'https://dummyimage.com/28x28/111/fff&text=S' },
    bonuses: [],
    probs: {},
    tickets: getMatchTickets(row.id)
  };
}

/**
 * Trae TODOS los partidos que a√∫n no se juegan:
 *  - status = 'NS'
 *  - start_time >= ahora
 * (sin l√≠mite de d√≠as hacia adelante)
 */
async function fetchUpcomingMatches() {
  const nowISO = new Date().toISOString();
  const { data, error } = await sb
    .from('matches')
    .select('*')
    .gte('start_time', nowISO)
    .order('start_time', { ascending: true });

  if (error) {
    console.warn('[fetchUpcomingMatches] ', error);
    return [];
  }
  return (data || []).map(mapMatchRowToUI);
}

/**
 * Live + Finished recientes para Results
 * (mantenemos 3 d√≠as hacia atr√°s para resultados)
 */
async function fetchLiveAndFinished() {
  const now = new Date();
  const threeDaysAgo = new Date(now.getTime() - (3 * 86400000)).toISOString();

  const { data, error } = await sb
    .from('matches')
    .select('*')
    .or('status.eq.LIVE,status.eq.FT')
    .gte('start_time', threeDaysAgo)
    .order('start_time', { ascending: true });

  if (error) {
    console.warn('[fetchLiveAndFinished] ', error);
    return [];
  }
  return (data || []).map(mapMatchRowToUI);
}

// Carga inicial (ambas p√°ginas)
async function loadAllMatches() {
  const [upcoming, liveFinished] = await Promise.all([
    fetchUpcomingMatches(),   // TODOS los futuros (NS)
    fetchLiveAndFinished()    // LIVE + FT (√∫ltimos 3 d√≠as)
  ]);
  const map = new Map();
  [...upcoming, ...liveFinished].forEach(m => map.set(m.id, m));
  matches = [...map.values()];
  await hydrateMatchTickets(matches);
  renderMatches();
  renderResults();
}

// Realtime: escucha cambios en matches (status, score, minute, start/lock)
function subscribeMatchesRealtime() {
  const ch = sb.channel('realtime-matches')
    .on('postgres_changes',
      { event: '*', schema: 'public', table: 'matches' },
      async (payload) => {
        const row = payload.new || payload.old;
        if (!row) return;
        const idx = matches.findIndex(m => m.id === row.id);

        if (payload.eventType === 'DELETE') {
		  matchTicketsCache.delete(Number(row.id));
          if (idx >= 0) { matches.splice(idx, 1); renderMatches(); renderResults(); }
          return;
        }

        const mapped = mapMatchRowToUI(payload.new || row);
        if (idx >= 0) {
          const merged = { ...matches[idx], ...mapped };
          matches[idx] = merged;
          await hydrateMatchTickets([merged]);
        } else {
          matches.push(mapped);
		  await hydrateMatchTickets([mapped]);
        }
        renderMatches();
        renderResults();
      }
    );
  ch.subscribe();
}

// Arranque
loadAllMatches().then(subscribeMatchesRealtime);

/* ===== REWARDS DATA (historial + badges) ===== */
const historyData = [
  {date:addMinutes(new Date(),-60*24*1), league:"LaLiga",   match:"Real Madrid vs Barcelona",     rank:2, total:120, lukas:18, status:"Won"},
  {date:addMinutes(new Date(),-60*24*2), league:"Premier League", match:"Man City vs Arsenal",   rank:15,total:140,lukas:0,  status:"No prize"},
  {date:addMinutes(new Date(),-60*24*3), league:"Serie A", match:"Juventus vs AC Milan",         rank:1, total:98, lukas:25, status:"Won"},
  {date:addMinutes(new Date(),-60*24*4), league:"Champions League", match:"PSG vs Bayern",       rank:34,total:210,lukas:0,  status:"No prize"},
  {date:addMinutes(new Date(),-60*24*6), league:"Liga 1 Per√∫", match:"Alianza vs Universitario", rank:5, total:160,lukas:8,  status:"Won"},
  {date:addMinutes(new Date(),-60*24*8), league:"LaLiga",  match:"Sevilla vs Atl√©tico",          rank:67,total:180,lukas:0,  status:"No prize"},
];

const badgesTemplate = [
  {id:'streak3',  name:'Warm-up',   days:3,  reward:5},
  {id:'streak7',  name:'On Fire',   days:7,  reward:12},
  {id:'streak14', name:'Unstoppable',days:14,reward:25},
  {id:'streak30', name:'Legend',    days:30, reward:60},
];
let claimedBadges=new Set();

/* ===== HELPERS ===== */
function samplePlayers(){const n=["Carlos","Ana","Miguel","Sof√≠a","Luis","Mar√≠a","Diego","Valeria","Jorge","Luc√≠a","Pablo","Camila"];return n.map((x,i)=>({id:i+1,name:x+" "+String.fromCharCode(65+i)+".",avatar:`https://i.pravatar.cc/48?img=${10+i}`,points:Math.floor(Math.random()*25),picks:{s1:["HOME","DRAW","AWAY"][Math.floor(Math.random()*3)],s2:Math.random()>.5?"YES":"NO",s3:Math.random()>.5?"OVER":"UNDER",s4:Math.random()>.5?"YES":"NO",s5:`${Math.floor(Math.random()*3)}-${Math.floor(Math.random()*3)}`}}));}
function addMinutes(date,m){return new Date(date.getTime()+m*60000)}
function fmtCountdown(ms){if(ms<0) return "00:00:00"; const s=Math.floor(ms/1000),h=String(Math.floor(s/3600)).padStart(2,'0'),m=String(Math.floor((s%3600)/60)).padStart(2,'0'),se=String(s%60).padStart(2,'0'); return `${h}:${m}:${se}`;}
function fmtTime(d){return new Date(d).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}
function fmtDateLine(d){const dt=new Date(d);const day=dt.toLocaleDateString([], {weekday:'short'});const md=dt.toLocaleDateString([], {month:'short',day:'numeric'}); const t=fmtTime(d);return `${day}, ${md} ‚Ä¢ ${t}`}
function el(id){return document.getElementById(id)}
function showToast(msg){el('toast-text').textContent=msg; const b=el('toast'); b.classList.remove('hidden'); setTimeout(()=>b.classList.add('hidden'),2200);}
function fmtCountdownWithDays(ms){if (ms < 0) return "00:00:00";
  const totalSec = Math.floor(ms / 1000);
  const days = Math.floor(totalSec / 86400);
  const rem  = totalSec % 86400;
  const h = String(Math.floor(rem / 3600)).padStart(2,'0');
  const m = String(Math.floor((rem % 3600) / 60)).padStart(2,'0');
  const s = String(rem % 60).padStart(2,'0');
  return days > 0 ? `${days}d ${h}:${m}:${s}` : `${h}:${m}:${s}`;
}

/* ===== ACCOUNT DATA ===== */
const avatarLibrary = Array.from({length: 24}, (_,i)=>`https://i.pravatar.cc/120?img=${i+1}`);
          
/* ===== STRIP BUILDER ===== */
function buildStripHTML(match, size='md'){
  const h = match.home, a = match.away;

  const leftW = size==='lg' ? 'w-44' : 'w-36';
  const imgSz = size==='lg' ? 'w-16 h-16' : 'w-12 h-12';
  const py    = size==='lg' ? 'py-4'      : 'py-3';
  const f1    = size==='lg' ? 'text-sm'   : 'text-xs';
  const f2    = size==='lg' ? 'text-[11px]' : 'text-[10px]';

  return `
    <div class="strip flex rounded-lg overflow-hidden">
      <div class="side ${leftW} ${h.color}">
        <div class="flex flex-col items-center justify-center ${py} text-white">
          <div class="${imgSz} rounded-full bg-white/10 flex items-center justify-center font-bold text-[10px] leading-none px-2 text-center">
            ${(h.name||'Home').slice(0,14)}
          </div>
        </div>
      </div>

      <div class="center flex-1 ${py} text-center">
        <div class="mx-auto">
          <div class="line-1 ${f1}">${fmtDateLine(match.startISO)}</div>
          <div class="line-3 ${f2} opacity-90">${match.league||'‚Äî'}</div>
        </div>
      </div>

      <div class="side ${leftW} ${a.color}">
        <div class="flex flex-col items-center justify-center ${py} text-white">
          <div class="${imgSz} rounded-full bg-white/10 flex items-center justify-center font-bold text-[10px] leading-none px-2 text-center">
            ${(a.name||'Away').slice(0,14)}
          </div>
        </div>
      </div>
    </div>`;
}
	
/* ===== MATCHES LIST ===== */
const countdownTimers = new Map();

function renderMatches(){
  const box = el('matches-vertical');
  box.innerHTML = '';

  // Limpia timers previos
  countdownTimers.forEach(id => clearInterval(id));
  countdownTimers.clear();

  // Todos los pr√≥ximos (no s√≥lo hoy)
  const ups = [...matches]
    .filter(m => new Date(m.startISO) > new Date())
    .sort((a,b) => new Date(a.startISO) - new Date(b.startISO));

  const heroSubtitle = el('hero-personal-sub');
  if (heroSubtitle) {
    heroSubtitle.textContent = currentUser
      ? 'Sigue tus combinadas activas y ajusta antes del kickoff.'
      : 'Inicia sesi√≥n para crear y seguir tus propias combinadas.';
  }

  // h√©roe: combinadas propias activas
  const heroTickets = ups.reduce((acc, m) => acc + getMyTickets(m).length, 0);
  const heroTicketsEl = el('hero-my-tickets');
  if (heroTicketsEl) {
    heroTicketsEl.textContent = heroTickets;
  }

  const heroSubtitleStats = el('hero-personal-sub');
  if (heroSubtitleStats && currentUser && heroTickets > 0) {
    heroSubtitleStats.textContent = `Tienes ${heroTickets} combinada${heroTickets === 1 ? '' : 's'} activas hoy.`;
  }

  ups.forEach(m => {
    const myTickets = getMyTickets(m);
    const d = dist(myTickets);
    const playerCount = myTickets.length;
    const hasTickets = playerCount > 0;
    const buttonLabel = !currentUser
      ? 'Inicia sesi√≥n'
      : 'Crear nueva combinada';
    const buttonIcon = !currentUser ? 'fa-arrow-right-to-bracket' : 'fa-plus';
	
    const row = document.createElement('div');
    row.className = "rounded-xl border bg-white hover:shadow-md transition";
    row.setAttribute('data-match-id', m.id);

    // GRID: [strip (>=50%)] [players] [trending] [countdown] [cta]
    // Usamos 4fr para la 1¬™ col y 1fr para las dem√°s ‚Üí 4/(4+1+1+1+1)=50%
    row.innerHTML = `
      <div class="w-full p-0">
        <div class="grid grid-cols-[4fr_1fr_1fr_1fr_1fr] gap-3 items-center px-4 py-3">
          <!-- Col 1: strip del partido -->
          <div class="relative">
            ${buildStripHTML(m,'md')}
            <div class="pill">Kickoff in <span id="cd-${m.id}">--:--:--</span></div>
          </div>

          <!-- Col 2: players (centrado) -->
          <div class="flex flex-col items-center justify-center text-center">
            <div class="text-xs text-gray-600 mb-1">Mis combinadas</div>
            <div class="text-sm font-semibold text-gray-800">
              ${playerCount}
            </div>
          </div>

          <!-- Col 3: trending (centrado) -->
          <div class="hidden sm:flex flex-col items-center justify-center text-center">
            <div class="text-xs text-gray-600 mb-1">Mi tendencia</div>
            <div class="dist-bar bg-gray-200 w-full max-w-[220px]">
              <div style="width:${d.home}%" class="h-full float-left bg-green-600"></div>
              <div style="width:${d.draw}%" class="h-full float-left bg-gray-400"></div>
              <div style="width:${d.away}%" class="h-full bg-blue-500"></div>
            </div>
            <div class="mt-1 text-[11px] text-gray-500 w-full max-w-[220px] flex justify-between">
              <span>H ${d.home}%</span><span>D ${d.draw}%</span><span>A ${d.away}%</span>
            </div>
          </div>

          <!-- Col 4: countdown (centrado) -->
          <div class="flex flex-col items-center justify-center text-center">
            <div class="text-xs text-gray-600 mb-1">To lock</div>
            <div class="text-sm font-semibold text-red-600" id="cd-dup-${m.id}">--:--:--</div>
          </div>

          <!-- Col 5: CTA (centrado) -->
          <div class="flex items-center justify-center">
            <button
              class="px-4 py-2 rounded-lg bg-primary text-white text-sm font-semibold hover:bg-emerald-600"
              data-open-ticket="${m.id}">
              <i class="fa-solid ${buttonIcon} mr-1"></i> ${buttonLabel}
            </button>
          </div>
        </div>
        <div class="border-t bg-gray-50">
          <div class="px-4 py-3 flex flex-col gap-3 text-xs text-gray-600 sm:flex-row sm:items-start sm:justify-between">
            <div class="flex-1 flex items-start gap-2 text-left">
              <i class="fa-solid fa-list-check text-primary mt-[2px]"></i>
              <div class="w-full">
                ${buildMatchTicketSummary(m, myTickets)}
              </div>
            </div>
            <button
              type="button"
              class="inline-flex items-center justify-center gap-2 rounded-lg border border-primary/30 bg-white px-3 py-2 text-xs font-semibold text-primary transition hover:border-primary hover:bg-primary/5"
              data-open-results="${m.id}">
              <i class="fa-solid fa-signal"></i>
              <span>Follow Live</span>
            </button>
          </div>
        </div>
      </div>`;

    // Timers
	const pillSpan   = row.querySelector(`#cd-${m.id}`);
	const dupSpan    = row.querySelector(`#cd-dup-${m.id}`);
	const tick       = ()=>{
	  const ms = new Date(m.startISO) - new Date();
	  // Pill "Kickoff in": mismo formato HH:MM:SS
	  const tKickoff = fmtCountdown(ms);
	  // Columna "To lock": con d√≠as si corresponde
	  const tLock    = fmtCountdownWithDays(ms);
	  if (pillSpan) pillSpan.textContent = tKickoff;
	  if (dupSpan)  dupSpan.textContent  = tLock;
	};
	tick();
	const tId = setInterval(tick, 1000);
	countdownTimers.set(m.id, tId);

    box.appendChild(row);
  });

  // Delegaci√≥n de click (abre tickets logueado o no)
  box.removeEventListener('click', _matchesDelegatedClick, true);
  box.addEventListener('click', _matchesDelegatedClick, true);
}
	
// Handler delegado para abrir Ticket
function _matchesDelegatedClick(ev){
  const ticketBtn = ev.target.closest('[data-open-ticket]');
  if (ticketBtn) {
    const id  = Number(ticketBtn.getAttribute('data-open-ticket'));
    if (!Number.isFinite(id)) return;
    ev.preventDefault();
    openTicket(id); // mantiene l√≥gica: invitados pueden abrir; submit s√≥lo si logueado
    return;
  }

  const resultsBtn = ev.target.closest('[data-open-results]');
  if (!resultsBtn) return;
  const resId = Number(resultsBtn.getAttribute('data-open-results'));
  if (!Number.isFinite(resId)) return;
  ev.preventDefault();
  try { showView('results'); } catch(_) {}
  openResultsDrawer(resId);
}
function dist(tickets){
  const arr = Array.isArray(tickets) ? tickets : [];
  const counts = { HOME:0, DRAW:0, AWAY:0 };
  arr.forEach(t => {
    const pick = t?.picks?.s1;
    if (pick && counts[pick] !== undefined) {
      counts[pick]++;
    }
  });
  const total = arr.length || 1;
  return {
    home: Math.round((counts.HOME * 100) / total),
    draw: Math.round((counts.DRAW * 100) / total),
    away: Math.round((counts.AWAY * 100) / total)
  };
}

const PICK_LABELS = { s1:'P1', s2:'P2', s3:'P3', s4:'P4', s5:'P5' };

function formatTicketDateTime(value, options){
  if (!value) return null;
  try {
    const dt = new Date(value);
    if (Number.isNaN(dt.getTime())) return null;
    return dt.toLocaleString([], options || { dateStyle:'short', timeStyle:'short' });
  } catch (_) {
    return null;
  }
}

function formatTicketTime(value){
  return formatTicketDateTime(value, { hour:'2-digit', minute:'2-digit' });
}

function formatTicketStatus(ticket){
  const liveScore = ticket?.liveScore || {};
  const updatedLabel = formatTicketTime(liveScore.updatedAt);
  if (updatedLabel) {
    return `Actualizado ${updatedLabel}`;
  }
  if (ticket?.submittedAt) {
    return 'Esperando resultados';
  }
  return 'Sin enviar';
}

function buildTicketPickBadges(ticket){
  const picks = ticket?.picks || {};
  const badges = Object.keys(PICK_LABELS)
    .map(key => {
      const value = picks[key];
      if (!value) return '';
      return `<span class="px-2 py-1 rounded-full border border-gray-200 bg-white text-[11px] font-medium text-gray-700">${PICK_LABELS[key]}: <span class="font-semibold text-gray-900">${value}</span></span>`;
    })
    .filter(Boolean);
  return badges.length ? badges.join('') : '<span class="text-[11px] text-gray-500">Sin picks registrados.</span>';
}

function buildMatchTicketSummary(match, tickets){
  if (!isLoggedIn()) {
    return '<div class="text-xs text-gray-600">Inicia sesi√≥n para ver tus combinadas y crear nuevas para este partido.</div>';
  }

  const list = Array.isArray(tickets) ? [...tickets] : [];
  if (!list.length) {
    return '<div class="text-xs text-gray-600">A√∫n no has creado combinadas para este partido. Usa el bot√≥n para comenzar.</div>';
  }

  list.sort((a, b) => {
    const aDate = a?.submittedAt ? new Date(a.submittedAt) : null;
    const bDate = b?.submittedAt ? new Date(b.submittedAt) : null;
    const aTime = aDate && !Number.isNaN(aDate.getTime()) ? aDate.getTime() : 0;
    const bTime = bDate && !Number.isNaN(bDate.getTime()) ? bDate.getTime() : 0;
    return aTime - bTime;
  });

  const headerCells = ['Combinada', 'Creada', 'P1', 'P2', 'P3', 'P4', 'P5']
    .map(label => `<th class="px-3 py-2 text-left font-semibold uppercase tracking-wide text-[11px] text-gray-500">${label}</th>`)
    .join('');

  const rows = list.map((ticket, idx) => {
    const submittedLabel = formatTicketDateTime(ticket?.submittedAt) || 'Sin enviar';
    const updatedLabel = formatTicketTime(ticket?.liveScore?.updatedAt);
    const picks = ticket?.picks || {};

    const pickCells = ['s1', 's2', 's3', 's4', 's5']
      .map(key => `<td class="px-3 py-2 text-sm font-semibold text-gray-800">${picks[key] || '‚Äî'}</td>`)
      .join('');

    return `
      <tr class="odd:bg-white even:bg-gray-50">
        <td class="px-3 py-2 text-sm font-semibold text-gray-900">Combinada ${idx + 1}</td>
        <td class="px-3 py-2 text-sm text-gray-700">
          <div>${submittedLabel}</div>
          ${updatedLabel ? `<div class="text-[11px] text-gray-500">Actualizado ${updatedLabel}</div>` : ''}
        </td>
        ${pickCells}
      </tr>`;
  }).join('');

  return `
    <div class="overflow-x-auto">
      <table class="min-w-full text-xs text-gray-600">
        <thead class="bg-white">
          <tr>${headerCells}</tr>
        </thead>
        <tbody class="divide-y divide-gray-100">${rows}</tbody>
      </table>
    </div>`;
}

function buildMatchTicketsHTML(tickets, options = {}) {
  const { matchId = null } = options;

  if (!isLoggedIn()) {
    return `
      <div class="px-4 py-3 text-sm text-gray-600 bg-white rounded-lg border flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <span>Inicia sesi√≥n para crear tus combinadas y verlas aqu√≠.</span>
        <button type="button" class="px-3 py-1.5 text-sm font-semibold rounded-lg bg-primary text-white hover:bg-emerald-600" onclick="openAuthFlow('signin')">
          Inicia sesi√≥n
        </button>
      </div>`;
  }

  const list = Array.isArray(tickets) ? tickets : [];
	
  if (!list.length) {
    const cta = Number.isFinite(Number(matchId))
      ? `<button type="button" class="px-3 py-1.5 text-sm font-semibold rounded-lg bg-primary text-white hover:bg-emerald-600 flex items-center justify-center gap-1" data-open-ticket="${matchId}">
          <i class="fa-solid fa-plus"></i>
          Crear nueva combinada
        </button>`
      : '';

    return `
      <div class="px-4 py-3 text-sm text-gray-600 bg-white rounded-lg border flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <span>A√∫n no tienes combinadas para este partido.</span>
        ${cta}
      </div>`;
  }

  const rows = list.map(ticket => {
    const picks = ticket?.picks || {};
    const submittedLabel = formatTicketDateTime(ticket?.submittedAt) || '‚Äî';
    const updatedLabel = formatTicketTime(ticket?.liveScore?.updatedAt);
    const statusText = formatTicketStatus(ticket);

    const pickBlocks = ['s1', 's2', 's3', 's4', 's5'].map((key, idx) => {
      const value = picks[key] || '‚Äî';
      return `
        <div class="flex flex-col rounded-lg border border-gray-200 bg-gray-50 px-3 py-2">
          <span class="text-[11px] font-semibold uppercase text-gray-500">P${idx + 1}</span>
          <span class="text-sm font-semibold text-gray-800">${value}</span>
        </div>`;
    }).join('');

    return `
      <div class="rounded-lg border bg-white p-4 space-y-4">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div>
            <div class="text-xs uppercase text-gray-500">Enviada</div>
            <div class="text-sm font-semibold text-gray-900">${submittedLabel}</div>
          </div>
          <div class="text-left sm:text-right">
            <div class="text-xs uppercase text-gray-500">Estado</div>
            <div class="text-sm font-semibold text-gray-900">${statusText}</div>
            ${updatedLabel ? `<div class="text-[11px] text-gray-500">Actualizado ${updatedLabel}</div>` : ''}
          </div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-5 gap-2">
          ${pickBlocks}
        </div>
      </div>`;
  }).join('');

  return `<div class="space-y-3">${rows}</div>`;
}

/* ===== RESULTS LIST ===== */
function renderResults(){
  const now = new Date();

  // Clasificaci√≥n basada en tiempo + status (coincidente con requisitos)
  const isLive = (m)=>{
    const start = new Date(m.startISO);
    const end   = addMinutes(start, m.durMin || 110);
    return now >= start && now < end;
  };
  const isUpcoming = (m)=> new Date(m.startISO) > now;
  const isFinished = (m)=>{
    const end = addMinutes(new Date(m.startISO), m.durMin || 110);
    return now >= end;
  };

  // LIVE (todos)
  const live = matches
    .filter(isLive)
    .sort((a,b)=> new Date(a.startISO) - new Date(b.startISO));

  // UPCOMING (todos los que ya mostramos en Matches)
  const upcoming = matches
    .filter(isUpcoming)
    .sort((a,b)=> new Date(a.startISO) - new Date(b.startISO));

  // FINISHED (s√≥lo √∫ltimos 3 d√≠as; ya viene acotado desde el fetch; lo reordenamos)
  const finished = matches
    .filter(isFinished)
    .sort((a,b)=> new Date(b.startISO) - new Date(a.startISO));

  // Banner ‚ÄúHot match‚Äù: el pr√≥ximo m√°s cercano
  if (upcoming[0]) {
    const u0    = upcoming[0];
    const d     = dist(resolveMatchTickets(u0));
    const bonus = (u0.bonuses || [])[0];
    el('banner-title').textContent = `${u0.league}: ${u0.home.name} vs ${u0.away.name}`;
    el('banner-sub').textContent   = `${d.home}% Home ‚Ä¢ ${d.draw}% Draw ‚Ä¢ ${d.away}% Away ‚Ä¢ Starts ${fmtTime(u0.startISO)}`;
    const bb = el('banner-bonus');
    if (bonus){ bb.textContent = bonus; bb.classList.remove('hidden'); } else { bb.classList.add('hidden'); }
  }
  el('banner-cta').onclick = () => showView('matches');

  // Bloque LIVE
  el('live-block').classList.toggle('hidden', live.length === 0);
  if (live.length) buildTable('live-table', live, false);

  // Tabla general: Upcoming primero y luego Finished (3d)
  buildTable('all-table', [...upcoming, ...finished], true);
}
function buildTable(containerId, items, showDateGroup){
  const wrap=el(containerId); wrap.innerHTML='';
  const table=document.createElement('div'); table.className='w-full';
  table.innerHTML=`
    <div class="grid grid-cols-[1.1fr,1fr,1.4fr,60px,1.4fr,1.6fr,1.2fr] text-[12px] text-gray-500 px-3 py-2">
      <div>Date & Time</div><div>League</div><div class="pl-2">Home</div><div class="text-center">vs</div><div class="pl-2">Away</div><div class="text-center">Status</div><div>Highlights</div>
    </div>
    <div class="divide-y" id="${containerId}-rows"></div>`;
  wrap.appendChild(table);

  const rows=el(`${containerId}-rows`); let lastGroup='';
  items.forEach(m=>{
    const now = new Date();
    const st = now < new Date(m.startISO)
      ? 'upcoming'
      : (now < addMinutes(new Date(m.startISO), m.durMin || 110) ? 'live' : 'finished');
	const tickets = resolveMatchTickets(m);
    const playerCount = m.participants || (Array.isArray(tickets) ? tickets.length : 0);
    const group=groupLabel(m.startISO);
    if(showDateGroup && group!==lastGroup){ const g=document.createElement('div'); g.className='bg-gray-50 text-xs font-semibold text-gray-600 px-3 py-1.5'; g.textContent=group; rows.appendChild(g); lastGroup=group; }
    const r=document.createElement('button'); r.className='w-full hover:bg-gray-50';
    r.innerHTML=`
      <div class="grid grid-cols-[1.1fr,1fr,1.4fr,60px,1.4fr,1.6fr,1.2fr] items-center px-3 py-3">
        <div class="text-sm">${fmtDateLine(m.startISO)}</div>
        <div class="text-sm text-gray-700">${m.league}</div>
        <div class="flex items-center gap-2"><img src="${m.home.logo}" class="w-6 h-6 rounded-full"><span class="font-medium">${m.home.name}</span></div>
        <div class="text-center text-gray-400">VS</div>
        <div class="flex items-center gap-2"><img src="${m.away.logo}" class="w-6 h-6 rounded-full"><span class="font-medium">${m.away.name}</span></div>
        <div class="flex justify-center">${statusPill(st,m)}</div>
        <div class="text-xs">
          <div class="flex items-center gap-2 flex-wrap">
            ${(m.bonuses&&m.bonuses.length)?`<span class="px-2 py-0.5 rounded-full bg-amber-100 text-amber-800 font-semibold">Bonus</span>`:''}
            <span class="px-2 py-0.5 rounded-full bg-gray-100">üë• ${playerCount} players</span>
          </div>
        </div>
      </div>`;
    r.addEventListener('click',()=>openResultsDrawer(m.id));
    rows.appendChild(r);
  });
}
function statusPill(state, m){
  // m puede traer: score_home, score_away, live_minute
  if (state === 'live') {
    const score = (Number.isFinite(m.score_home) && Number.isFinite(m.score_away))
      ? `${m.score_home}-${m.score_away}` : '‚Äî';
    const min = m.live_minute ? `${m.live_minute}‚Äô` : '';
    return `
      <div class="flex items-center gap-2">
        <span class="status-pill bg-red-100 text-red-700">
          <span class="status-dot bg-red-600 animate-pulse"></span> Live
        </span>
        <span class="px-2 py-0.5 rounded bg-gray-900 text-white text-[11px] font-bold">${score}</span>
        <span class="text-[11px] text-gray-600">${min}</span>
      </div>`;
  }
  if (state === 'upcoming') {
    return `<span class="status-pill bg-amber-100 text-amber-700"><span class="status-dot bg-amber-500"></span>Upcoming</span>`;
  }
  // finished
  const fscore = (Number.isFinite(m.score_home) && Number.isFinite(m.score_away))
    ? `${m.score_home}-${m.score_away}` : 'FT';
  return `
    <div class="flex items-center gap-2">
      <span class="status-pill bg-gray-100 text-gray-700"><span class="status-dot bg-gray-500"></span>Finished</span>
      <span class="px-2 py-0.5 rounded bg-gray-800 text-white text-[11px] font-bold">${fscore}</span>
    </div>`;
}
function groupLabel(d){const dt=new Date(d); const today=new Date(); today.setHours(0,0,0,0); const delta=Math.floor((dt - today)/86400000); if(delta===0) return 'Today'; if(delta===1) return 'Tomorrow'; if(delta===-1) return 'Yesterday'; return dt.toLocaleDateString([], {weekday:'long',month:'short',day:'numeric'});}

// ===== LIVE LEADERBOARD (Results) =====
// Devuelve ranking para un match (RPC security definer)
async function getLeaderboard(matchId) {
  const { data, error } = await sb.rpc('get_leaderboard', { p_match_id: matchId });
  if (error) {
    console.warn('[get_leaderboard]', error);
    return [];
  }
  return data || [];
}

// Nos suscribimos a cambios en ticket_scores_live para refrescar sidebar/lista
let _tslChannel = null;
function subscribeLeaderboardRealtime(matchId, onUpdate) {
  if (_tslChannel) { try { sb.removeChannel(_tslChannel); } catch {} }
  _tslChannel = sb.channel('realtime-tsl-' + matchId)
    .on('postgres_changes',
      { event: '*', schema: 'public', table: 'ticket_scores_live', filter: `match_id=eq.${matchId}` },
      async () => {
        const lb = await getLeaderboard(matchId);
        if (typeof onUpdate === 'function') onUpdate(lb);
      }
    );
  _tslChannel.subscribe();
}

// RPC simple y directa: debe existir en el backend
async function getLeaderboardWithPicks(matchId){
  const { data, error } = await sb.rpc('get_leaderboard_with_picks', { p_match_id: matchId });
  if (error) { console.warn('[get_leaderboard_with_picks]', error); return []; }
  return data || [];
}

async function getMatchTicketsDetailed(matchId){
  try {
    const { data, error } = await sb.rpc('get_match_tickets_with_picks', { p_match_id: matchId });
    if (error) {
      console.warn('[get_match_tickets_with_picks]', error);
      return [];
    }
    return data || [];
  } catch (err) {
    console.warn('[get_match_tickets_with_picks][catch]', err);
    return [];
  }
}

function resolveEntryFee(matchObj = {}){
  const raw = Number(matchObj.entry_fee ?? matchObj.entryFee ?? 10);
  return Number.isFinite(raw) && raw > 0 ? raw : 10;
}

function calculatePot(matchObj, participantCount){
  const count = Number(participantCount) || 0;
  return resolveEntryFee(matchObj) * count;
}

function calculatePrizeBreakdown(pot){
  const base = Number(pot) || 0;
  return [base * 0.5, base * 0.35, base * 0.15];
}

function buildPotInfo(matchObj, participantCount){
  const entryFee = resolveEntryFee(matchObj);
  const pot = calculatePot(matchObj, participantCount);
  const breakdown = calculatePrizeBreakdown(pot);
  const prizeByRank = (rank) => {
    if (!Number.isFinite(rank)) return 0;
    const idx = Number(rank) - 1;
    return idx >= 0 && idx < breakdown.length ? breakdown[idx] : 0;
  };
  return { entryFee, participantCount, pot, breakdown, prizeByRank };
}

function matchEndedWithinDays(matchObj = {}, days = 7){
  try {
    const start = new Date(matchObj.startISO || matchObj.start_time);
    if (Number.isNaN(start.getTime())) return true;
    const dur = Number(matchObj.durMin || matchObj.dur_min || 110) || 110;
    const end = addMinutes(start, dur);
    const now = new Date();
    if (now < end) return true;
    const diff = now.getTime() - end.getTime();
    return diff <= (Number(days) || 0) * 86400000;
  } catch (err) {
    console.warn('[matchEndedWithinDays]', err);
    return false;
  }
}

function formatMoney(value){
  const num = Number(value);
  if (!Number.isFinite(num)) return 'S/ 0.00';
  return `S/ ${num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
}

function resolveMatchState(matchObj = {}) {
  try {
    const now = new Date();
    const startRaw = matchObj.startISO || matchObj.start_time;
    const start = startRaw ? new Date(startRaw) : null;
    if (!start || Number.isNaN(start.getTime())) return 'upcoming';
    const dur = Number(matchObj.durMin || matchObj.dur_min || 110) || 110;
    const end = addMinutes(start, dur);
    if (now < start) return 'upcoming';
    if (now < end) return 'live';
    return 'finished';
  } catch (err) {
    console.warn('[resolveMatchState]', err);
    return 'upcoming';
  }
}

function expandLeaderboardRows(rows = []){
  return rows.flatMap(row => {
    if (Array.isArray(row?.tickets) && row.tickets.length) {
      return row.tickets.map(ticket => {
        const merged = {
          ...row,
          ...ticket,
          full_name: ticket.full_name ?? row.full_name ?? row.fullName ?? row.name,
          username: ticket.username ?? row.username ?? row.user_name,
          avatar_url: ticket.avatar_url ?? row.avatar_url ?? row.avatar,
          submitted_at: ticket.submitted_at ?? ticket.created_at ?? row.submitted_at ?? row.created_at ?? null,
          updated_at: ticket.updated_at ?? ticket.score_updated_at ?? row.updated_at ?? row.score_updated_at ?? null,
          rank: ticket.rank ?? row.rank,
          prize_amount: typeof ticket.prize_amount === 'number' ? ticket.prize_amount : row.prize_amount,
          score: ticket.score ?? ticket.points ?? row.score ?? row.points ?? null,
          ticket_id: ticket.ticket_id ?? ticket.id ?? row.ticket_id ?? row.id ?? null,
        };
        delete merged.tickets;
        return merged;
      });
    }
    const clone = { ...row };
    if (clone.tickets) delete clone.tickets;
    if (!('ticket_id' in clone) && (clone.ticketId || clone.id)) {
      clone.ticket_id = clone.ticketId ?? clone.id;
    }
    return clone;
  });
}

function ensureExpandedLeaderboard(rows = []){
  if (!Array.isArray(rows)) return [];
  const needsExpansion = rows.some(r => Array.isArray(r?.tickets));
  if (needsExpansion) {
    return expandLeaderboardRows(rows);
  }
  return rows.map(row => {
    const clone = { ...row };
    if (clone.tickets) delete clone.tickets;
    if (!('ticket_id' in clone) && (clone.ticketId || clone.id)) {
      clone.ticket_id = clone.ticketId ?? clone.id;
    }
    return clone;
  });
}

// Pinta lista con columnas: #, user, P1..P5, Premio
async function paintParticipants(matchObj) {
  const list = document.getElementById('players-list');
  if (!list) return;

  const pc = document.getElementById('participants-count');
  if (pc) pc.textContent = 'Loading‚Ä¶';
  list.innerHTML = `<div class="px-4 py-6 text-sm text-gray-500">Cargando leaderboard‚Ä¶</div>`;

  const initialState = resolveMatchState(matchObj);

  if (initialState === 'finished' && !matchEndedWithinDays(matchObj, 7)) {
    drawLeaderboard(list, [], initialState, matchObj, buildPotInfo(matchObj, 0));
    renderRightStats([], matchObj, initialState, buildPotInfo(matchObj, 0));
    return;
  }

  let leaderboard = [];
  try {
    leaderboard = initialState === 'upcoming'
      ? await getMatchTicketsDetailed(matchObj.id)
      : await getLeaderboardWithPicks(matchObj.id);
  } catch (err) {
    console.warn('[paintParticipants]', err);
    leaderboard = [];
  }

  const expanded = ensureExpandedLeaderboard(leaderboard);
  const info = buildPotInfo(matchObj, expanded.length);

  // Realtime (si cambia el live score o los puntos)
  subscribeLeaderboardRealtime(matchObj.id, async () => {
    try {
      const nextState = resolveMatchState(matchObj);
      if (nextState === 'finished' && !matchEndedWithinDays(matchObj, 7)) {
        drawLeaderboard(list, [], nextState, matchObj, buildPotInfo(matchObj, 0));
        renderRightStats([], matchObj, nextState, buildPotInfo(matchObj, 0));
        return;
      }
      const lb = nextState === 'upcoming'
        ? await getMatchTicketsDetailed(matchObj.id)
        : await getLeaderboardWithPicks(matchObj.id);
      const expandedRt = ensureExpandedLeaderboard(lb);
      const rtInfo = buildPotInfo(matchObj, expandedRt.length);
      drawLeaderboard(list, expandedRt, nextState, matchObj, rtInfo);
      renderRightStats(expandedRt, matchObj, nextState, rtInfo); // refresca panel derecho
    } catch (err) {
      console.warn('[paintParticipants][realtime]', err);
    }
  });

  drawLeaderboard(list, expanded, initialState, matchObj, info);
  renderRightStats(expanded, matchObj, initialState, info); // primer pintado
}

function extractTicketPicks(row){
  const picks = {};
  const assignIfValue = (key, value) => {
    if (value !== undefined && value !== null && value !== '') {
      picks[key] = value;
    }
  };

  Object.keys(PICK_LABELS).forEach(key => {
    assignIfValue(key, row?.[key]);
  });

  const fromPicks = row?.picks;
  if (fromPicks && typeof fromPicks === 'object') {
    Object.keys(PICK_LABELS).forEach(key => {
      if (!picks[key]) {
        assignIfValue(key, fromPicks[key] ?? fromPicks[key.toUpperCase()] ?? fromPicks[`p${key.slice(1)}`]);
      }
    });
  }

  if (!Object.keys(picks).length && row?.details) {
    let details = row.details;
    if (typeof details === 'string') {
      try { details = JSON.parse(details); } catch (_) { details = null; }
    }
    if (details && typeof details === 'object') {
      Object.keys(PICK_LABELS).forEach(key => {
        if (!picks[key]) {
          assignIfValue(key, details[key] ?? details[key.toUpperCase()] ?? details[`p${key.slice(1)}`]);
        }
      });
    }
  }

  return picks;
}

function normalizeLeaderboardRow(row, idx, info = {}){
  const rawRank = Number(row?.rank);
  const rank = Number.isFinite(rawRank) && rawRank > 0 ? rawRank : (idx + 1);
  const name = row?.full_name || row?.fullName || row?.name || row?.player_name || row?.username || 'Jugador';
  const username = row?.username || row?.user_name || '';
  const avatarSeed = row?.avatar_url || row?.avatar || row?.user_id || row?.userId || username || name || `p-${rank}`;
  const avatar = row?.avatar_url || row?.avatar || `https://i.pravatar.cc/48?u=${encodeURIComponent(String(avatarSeed))}`;
  const picks = extractTicketPicks(row);
  const submittedAt = row?.submitted_at || row?.submittedAt || row?.created_at || null;
  const updatedAt = row?.updated_at || row?.score_updated_at || row?.details_updated_at || null;
  const scoreRaw = row?.points ?? row?.score ?? row?.total_points ?? null;
  const score = Number(scoreRaw);
  const prizeAmount = typeof row?.prize_amount === 'number' ? row.prize_amount : (info?.prizeByRank ? info.prizeByRank(rank) : 0);
  const ticketId = row?.ticket_id ?? row?.ticketId ?? null;

  return {
    rank,
    name,
    username,
    avatar,
    picks,
    submittedAt,
    submittedLabel: formatTicketDateTime(submittedAt) || 'Sin enviar',
    updatedAt,
    updatedLabel: formatTicketTime(updatedAt),
    score: Number.isFinite(score) ? score : null,
    scoreLabel: Number.isFinite(score) ? String(score) : '‚Äî',
    prizeAmount,
    prizeLabel: prizeAmount > 0 ? formatMoney(prizeAmount) : '‚Äî',
    ticketId,
  };
}

function drawLeaderboard(container, lb, state = 'upcoming', matchObj = {}, infoOverride = null) {
  const arr = ensureExpandedLeaderboard(Array.isArray(lb) ? lb : []);
  const matchState = state || 'upcoming';
  const info = infoOverride || buildPotInfo(matchObj, arr.length);
  const withinWindow = matchState !== 'finished' || matchEndedWithinDays(matchObj, 7);

  const pc = document.getElementById('participants-count');
  if (!withinWindow) {
    container.innerHTML = '<div class="px-4 py-6 text-sm text-gray-500">Los resultados de este partido est√°n disponibles solo durante 7 d√≠as despu√©s del pitazo final.</div>';
    if (pc) pc.textContent = '‚Äî';
    return;
  }

  if (!arr.length) {
    const messages = {
      upcoming: 'A√∫n no hay combinadas registradas para este partido. ¬°S√© el primero en participar!',
      live: 'Estamos calculando el leaderboard en vivo. Actualiza en unos segundos.',
      finished: 'No se registraron combinadas para este partido.',
    };
    container.innerHTML = `<div class="px-4 py-6 text-sm text-gray-500 text-center">${messages[matchState] || 'No hay datos disponibles.'}</div>`;
    if (pc) pc.textContent = '0 participantes';
    return;
  }

  const showScores = matchState === 'live' || matchState === 'finished';
  const picksOrder = ['s1', 's2', 's3', 's4', 's5'];

  const rows = arr.map((row, idx) => {
    const item = normalizeLeaderboardRow(row, idx, info);
    const highlightClass = (matchState === 'live' && item.rank === 1)
      ? 'bg-emerald-50'
      : ((matchState === 'finished' && item.prizeAmount > 0) ? 'bg-amber-50/60' : '');

    const pickCells = picksOrder.map(key => {
      const value = item.picks?.[key] || '‚Äî';
      return `<td class="px-2 py-3 align-top text-sm font-semibold text-gray-900">${value}</td>`;
    }).join('');

    const scoreCell = showScores ? item.scoreLabel : '‚Äî';
    const prizeCell = showScores ? item.prizeLabel : '‚Äî';
    const prizeClass = showScores && item.prizeAmount > 0 ? 'text-emerald-700' : 'text-gray-700';
    const ticketLabel = item.ticketId ? `<div class="mt-1 text-[11px] text-gray-500">Ticket #${item.ticketId}</div>` : '';

    return `
      <tr class="${highlightClass} align-top">
        <td class="px-4 py-3 text-sm font-semibold text-gray-900">#${item.rank}</td>
        <td class="px-4 py-3">
          <div class="flex items-center gap-3">
            <img src="${item.avatar}" alt="${item.name}" class="w-8 h-8 rounded-full object-cover">
            <div>
              <div class="text-sm font-semibold text-gray-900">${item.name}</div>
              ${item.username ? `<div class="text-xs text-gray-500">@${item.username}</div>` : ''}
              ${ticketLabel}
            </div>
          </div>
        </td>
        ${pickCells}
        <td class="px-4 py-3 text-sm font-semibold ${showScores ? 'text-gray-900' : 'text-gray-500'}">${scoreCell}</td>
        <td class="px-4 py-3 text-sm font-semibold ${prizeClass}">${prizeCell}</td>
      </tr>`;
  }).join('');

  container.innerHTML = `
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm text-gray-700">
        <thead class="bg-gray-50 text-xs font-semibold uppercase text-gray-500 tracking-wide">
          <tr>
            <th class="px-4 py-2 text-left">Pos.</th>
            <th class="px-4 py-2 text-left">Username</th>
            <th class="px-2 py-2 text-left">P1</th>
            <th class="px-2 py-2 text-left">P2</th>
            <th class="px-2 py-2 text-left">P3</th>
            <th class="px-2 py-2 text-left">P4</th>
            <th class="px-2 py-2 text-left">P5</th>
            <th class="px-4 py-2 text-left">Score</th>
            <th class="px-4 py-2 text-left">Premio</th>
          </tr>
        </thead>
        <tbody class="bg-white">${rows}</tbody>
      </table>
    </div>`;

  if (pc) {
    const label = arr.length === 1 ? '1 participante' : `${arr.length} participantes`;
    pc.textContent = label;
  }
}

// Hook en el open: despu√©s de abrir el drawer, pedimos lista + stats
const _openResultsDrawer_base = openResultsDrawer;
openResultsDrawer = async (id) => {
  _openResultsDrawer_base(id);
  const m = matches.find(mm => String(mm.id) === String(id));
  if (m) { await paintParticipants(m); }
};
	
/* ===== RESULTS DRAWER ===== */
let selectedRes=null, liveSorterTimer=null;
function openResultsDrawer(id){
  const m = matches.find(mm => String(mm.id) === String(id));
  if (!m) {
    console.warn('Result match not found:', id);
    showToast('Could not open match details.');
    return;
  }
  selectedRes = m;
  el('results-strip').innerHTML=buildStripHTML(selectedRes,'lg');
  renderResultsSidebar(selectedRes); renderPlayers(selectedRes);
  const pill=el('results-status-pill'); pill.textContent='DETAILS'; pill.className='text-xs font-semibold px-2 py-1 rounded-full bg-gray-100 text-gray-700';
  el('overlay').classList.remove('pointer-events-none'); el('overlay').classList.add('opacity-100');
  el('results-section').classList.add('opacity-60','blur-[2px]');
  document.getElementById('results-drawer').classList.remove('translate-x-full');
}
function closeResultsDrawer(){ el('overlay').classList.add('pointer-events-none'); el('overlay').classList.remove('opacity-100'); el('results-section').classList.remove('opacity-60','blur-[2px]'); document.getElementById('results-drawer').classList.add('translate-x-full');}
document.getElementById('results-back').addEventListener('click',closeResultsDrawer);
function renderResultsSidebar(m){
  el('res-sponsor-name').textContent='by '+(m.sponsor?.name||'Sponsor');
  el('res-bonus-list').innerHTML=(m.bonuses||[]).map(b=>`<div class="text-sm bg-yellow-50 border border-yellow-200 rounded px-2 py-1.5"><i class="fa-solid fa-bolt-lightning text-yellow-500 mr-1"></i>${b}</div>`).join('')||`<div class="text-xs text-gray-500">No active bonuses</div>`;
  el('live-time-label').textContent='Estado';
  el('live-time').textContent='‚Äî';
  // El resto (distribuciones, pozo, marcador) lo hace renderRightStats()
}
// Calcula % por opci√≥n
function pct(n, t){ return t>0 ? Math.round((n*100)/t) : 0; }

// Renderiza barras de distribuci√≥n (P1..P4) y lista de P5
function renderRightStats(lb, matchObj, state = null, infoOverride = null){
  const arr = ensureExpandedLeaderboard(Array.isArray(lb) ? lb : []);
  const total = arr.length;
  const matchState = state || resolveMatchState(matchObj);
  const info = infoOverride || buildPotInfo(matchObj, total);

  const statusLabel = el('live-time-label');
  const statusValue = el('live-time');
  const statusScore = el('live-score');
  const startRef = matchObj?.startISO || matchObj?.start_time;
  const kickoffLine = startRef ? fmtDateLine(startRef) : '';
  const scoreVal = (Number.isFinite(matchObj?.score_home) && Number.isFinite(matchObj?.score_away))
    ? `${matchObj.score_home}-${matchObj.score_away}`
    : null;

  if (statusLabel) {
    statusLabel.textContent = matchState === 'live' ? 'En vivo' : (matchState === 'finished' ? 'Finalizado' : 'Kickoff');
  }
  if (statusValue) {
    if (matchState === 'live') {
      statusValue.textContent = matchObj?.live_minute ? `${matchObj.live_minute}‚Äô` : 'Jug√°ndose';
    } else if (matchState === 'finished') {
      statusValue.textContent = 'FT';
    } else {
      statusValue.textContent = kickoffLine || 'Pendiente';
    }
  }
  if (statusScore) {
    if (matchState === 'live') {
      statusScore.textContent = scoreVal ? `Marcador: ${scoreVal}` : 'Actualizando marcador en vivo‚Ä¶';
    } else if (matchState === 'finished') {
      statusScore.textContent = scoreVal ? `Marcador final: ${scoreVal}` : 'Marcador final no disponible.';
    } else {
      statusScore.textContent = total
        ? `Pozo actual: ${formatMoney(info.pot)} ‚Ä¢ ${total} participante${total === 1 ? '' : 's'}`
        : 'A√∫n no hay combinadas registradas.';
    }
  }

  // P1
  const c1 = { HOME:0, DRAW:0, AWAY:0 };
  // P2
  const c2 = { YES:0, NO:0 };
  // P3
  const c3 = { OVER:0, UNDER:0 };
  // P4
  const c4 = { YES:0, NO:0 };
  // P5 (marcadores: top-5)
  const c5 = {};

  arr.forEach(r=>{
    if (r.s1 && c1[r.s1] !== undefined) c1[r.s1]++;
    if (r.s2 && c2[r.s2] !== undefined) c2[r.s2]++;
    if (r.s3 && c3[r.s3] !== undefined) c3[r.s3]++;
    if (r.s4 && c4[r.s4] !== undefined) c4[r.s4]++;
    if (r.s5) c5[r.s5] = (c5[r.s5]||0)+1;
  });

  const noDataMsg = '<div class="py-2 text-center text-[11px] text-gray-500">Sin picks a√∫n</div>';

  if (!total) {
    ['dist-p1','dist-p2','dist-p3','dist-p4'].forEach(id => {
      const node = el(id);
      if (node) node.innerHTML = noDataMsg;
    });
  } else {
    // P1 barras
    const p1h = pct(c1.HOME,total), p1d = pct(c1.DRAW,total), p1a = pct(c1.AWAY,total);
    el('dist-p1').innerHTML = `
      <div style="width:${p1h}%;" class="h-full float-left bg-green-600"></div>
      <div style="width:${p1d}%;" class="h-full float-left bg-gray-400"></div>
      <div style="width:${p1a}%;" class="h-full bg-blue-500"></div>`;

    // P2 barras
    const p2y=pct(c2.YES,total), p2n=pct(c2.NO,total);
    el('dist-p2').innerHTML = `
      <div style="width:${p2y}%;" class="h-full float-left bg-emerald-600"></div>
      <div style="width:${p2n}%;" class="h-full bg-gray-400"></div>`;

    // P3 barras
    const p3o=pct(c3.OVER,total), p3u=pct(c3.UNDER,total);
    el('dist-p3').innerHTML = `
      <div style="width:${p3o}%;" class="h-full float-left bg-indigo-600"></div>
      <div style="width:${p3u}%;" class="h-full bg-gray-400"></div>`;

    // P4 barras
    const p4y=pct(c4.YES,total), p4n=pct(c4.NO,total);
    el('dist-p4').innerHTML = `
      <div style="width:${p4y}%;" class="h-full float-left bg-rose-600"></div>
      <div style="width:${p4n}%;" class="h-full bg-gray-400"></div>`;
  }

  // P5 top-5 marcadores
  const p5node = el('dist-p5');
  const top5 = Object.entries(c5).sort((a,b)=>b[1]-a[1]).slice(0,5);
  if (p5node) {
    p5node.innerHTML = top5.length
      ? top5.map(([sc, n])=>`<div class="flex justify-between"><span>${sc}</span><span>${pct(n,total)}%</span></div>`).join('')
      : `<div class="text-gray-500 text-[11px]">Los marcadores aparecer√°n cuando haya picks.</div>`;
  }

  // Pozo (si tienes entry_fee o pot en DB √∫salo; fallback = jugadores * 10)
  const potNode = el('pot-amount');
  if (potNode) potNode.textContent = formatMoney(info.pot);
  const breakdown = info.breakdown || calculatePrizeBreakdown(info.pot);
  const p1 = el('prize-1'); if (p1) p1.textContent = formatMoney(breakdown[0] || 0);
  const p2 = el('prize-2'); if (p2) p2.textContent = formatMoney(breakdown[1] || 0);
  const p3 = el('prize-3'); if (p3) p3.textContent = formatMoney(breakdown[2] || 0);

  const panelPot = el('results-panel-pot');
  const panelStatus = el('results-panel-status');
  const panelLegend = el('results-panel-legend');
  const panelDistribution = el('results-panel-distribution');

  if (panelPot) {
    panelPot.classList.toggle('ring-2', matchState === 'upcoming');
    panelPot.classList.toggle('ring-primary/30', matchState === 'upcoming');
    panelPot.classList.toggle('bg-emerald-50', matchState === 'upcoming');
  }
  if (panelStatus) {
    panelStatus.classList.toggle('opacity-70', matchState === 'upcoming');
  }
  if (panelLegend) {
    panelLegend.classList.toggle('opacity-40', matchState === 'upcoming');
  }
  if (panelDistribution) {
    panelDistribution.classList.toggle('opacity-40', matchState === 'upcoming');
  }
}

function renderPlayers(){
  const list = el('players-list');
  if (!list) return;
  list.innerHTML = `<div class="px-4 py-6 text-sm text-gray-500">Cargando participantes‚Ä¶</div>`;
}

/* ===== DRAWER TICKET (Matches) ===== */
let selectedMatch = null;          // fila de DB `matches`
let picks = {};                    // { s1, s2, s3, s4, s5 }
let score = { home: 0, away: 0 };  // para la predicci√≥n de marcador
let _lockTimer = null;
let isSubmittingTicket = false;    // evita doble env√≠o concurrente

// Render simple del strip usando datos de DB (sin logos)
function buildStripFromDB(m){
  const dt  = new Date(m.start_time);
  const day = dt.toLocaleDateString([], { weekday:'short' });
  const md  = dt.toLocaleDateString([], { month:'short', day:'numeric' });
  const t   = dt.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
  const when= `${day}, ${md} ‚Ä¢ ${t}`;
  const league= m.league || '‚Äî';
  return `
    <div class="strip flex rounded-lg overflow-hidden shadow">
      <div class="side w-28 bg-emerald-600">
        <div class="text-white text-center font-bold px-2 py-3">${(m.home_team||'Home')}</div>
      </div>
      <div class="center flex-1 py-4 text-center">
        <div class="line-1 text-sm font-extrabold">${when}</div>
        <div class="line-3 text-[11px] opacity-90">${league}</div>
      </div>
      <div class="side w-28 bg-sky-600">
        <div class="text-white text-center font-bold px-2 py-3">${(m.away_team||'Away')}</div>
      </div>
    </div>`;
}

// Carga de match por id (desde DB)
async function fetchMatchById(matchId){
  const { data, error } = await sb
    .from('matches')
    .select('id, start_time, lock_time, dur_min, league, home_team, away_team')
    .eq('id', matchId)
    .maybeSingle();
  if (error) throw error;
  return data || null;
}

// Abre drawer de ticket
async function openTicket(matchOrId){
  try {
    // 1) Resolver el ID
    const matchId = (typeof matchOrId === 'object') ? matchOrId?.id : matchOrId;
    if (!matchId) { showToast('Could not open this match.'); return; }

    // 2) Cargar desde DB
    const m = await fetchMatchById(matchId);
    if (!m) { showToast('Match not found.'); return; }

    // 3) Verificar lock
    const now  = new Date();
    const lock = new Date(m.lock_time);
    if (now >= lock) {
      showToast('This match is locked. Follow live in Results.');
      try { showView('results'); } catch(_) {}
      return;
    }

    // 4) Estado base del drawer
    selectedMatch       = m;
    picks               = {};
    score               = { home: 0, away: 0 };
    isSubmittingTicket  = false;

    // 5) Pintar cabecera del drawer
    el('strip-ticket').innerHTML = buildStripFromDB(selectedMatch);
    el('ticket-lock-time').textContent = `Lock at ${fmtTime(selectedMatch.lock_time)}`;

    // 6) Contadores (hasta lock)
    const tick = ()=>{
      const ms = new Date(selectedMatch.lock_time) - new Date();
      const t  = fmtCountdown(ms);
      el('time-remaining').textContent = t;
      el('sidebar-clock').textContent  = t;
      // si pasa el lock mientras est√° abierto ‚Üí cerrar
      if (ms <= 0) {
        clearInterval(_lockTimer);
        _lockTimer = null;
        showToast('Locked. Redirecting to Results.');
        closeTicket();
        try { showView('results'); } catch(_) {}
      }
    };
    tick();
    if (_lockTimer) clearInterval(_lockTimer);
    _lockTimer = setInterval(tick, 1000);

    // 7) Render de predicciones (UI existente)
    renderPredictionsForDB(selectedMatch);

    // 8) Abrir drawer + overlay
    el('overlay').classList.remove('pointer-events-none');
    el('overlay').classList.add('opacity-100');
    el('matches-section').classList.add('opacity-60','blur-[2px]');
    el('ticket-drawer').classList.remove('translate-x-full');
    el('error-banner').classList.add('hidden');
  } catch (e) {
    console.error(e);
    showToast('Could not open this match.');
  }
}

// Cerrar drawer
function closeTicket(){
  if (_lockTimer) { clearInterval(_lockTimer); _lockTimer = null; }
  el('overlay').classList.add('pointer-events-none');
  el('overlay').classList.remove('opacity-100');
  el('matches-section').classList.remove('opacity-60','blur-[2px]');
  el('ticket-drawer').classList.add('translate-x-full');
  selectedMatch = null; picks = {}; isSubmittingTicket = false; updateCompleted();
}
document.getElementById('drawer-back').addEventListener('click', ()=>{
  if (selectedMatch && Object.keys(picks).length > 0) {
    if (!confirm("You haven't submitted your ticket yet. Leave anyway?")) return;
  }
  closeTicket();
});

// Render de tarjetas de predicci√≥n (id√©ntica UX, pero sin datos mock)
function renderPredictionsForDB(m){
  const hName = m.home_team || 'Home';
  const aName = m.away_team || 'Away';
  const grid  = el('predictions-grid');

  const card=(i,pts,body)=>`<div class="border border-gray-200 rounded-lg p-4">
    <div class="flex items-center justify-between mb-3">
      <span class="text-sm font-medium text-gray-500">Prediction ${i}/5</span>
      <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">+${pts} Lukas</span>
    </div>${body}
  </div>`;

  grid.innerHTML =
    // S1: 1X2
    card(1,3,`<div class="flex gap-2">
      <button data-s="s1" data-v="HOME" class="bg-gray-100 text-gray-700 py-2 px-3 rounded-lg font-medium text-sm hover:bg-gray-200 w-1/3">${hName}</button>
      <button data-s="s1" data-v="DRAW" class="bg-gray-100 text-gray-700 py-2 px-3 rounded-lg font-medium text-sm hover:bg-gray-200 w-1/3">Draw</button>
      <button data-s="s1" data-v="AWAY" class="bg-gray-100 text-gray-700 py-2 px-3 rounded-lg font-medium text-sm hover:bg-gray-200 w-1/3">${aName}</button>
    </div>`) +
    // S2: BTTS
    card(2,2,`<p class="text-lg font-medium text-gray-900 mb-3">Both teams to score?</p>
      <div class="flex gap-2">
        <button data-s="s2" data-v="YES" class="bg-gray-100 text-gray-700 py-2 px-3 rounded-lg font-medium text-sm hover:bg-gray-200 flex-1"><i class="fa-solid fa-check mr-2"></i>Yes</button>
        <button data-s="s2" data-v="NO"  class="bg-gray-100 text-gray-700 py-2 px-3 rounded-lg font-medium text-sm hover:bg-gray-200 flex-1"><i class="fa-solid fa-times mr-2"></i>No</button>
      </div>`) +
    // S3: Over/Under 2.5
    card(3,2,`<p class="text-lg font-medium text-gray-900 mb-3">Over 2.5 total goals?</p>
      <div class="flex gap-2">
        <button data-s="s3" data-v="OVER"  class="bg-gray-100 text-gray-700 py-2 px-3 rounded-lg font-medium text-sm hover:bg-gray-200 flex-1">Over 2.5</button>
        <button data-s="s3" data-v="UNDER" class="bg-gray-100 text-gray-700 py-2 px-3 rounded-lg font-medium text-sm hover:bg-gray-200 flex-1">Under 2.5</button>
      </div>`) +
    // S4: Tarjeta roja
    card(4,6,`<p class="text-lg font-medium text-gray-900 mb-3">Will there be a red card?</p>
      <div class="flex gap-2">
        <button data-s="s4" data-v="YES" class="bg-gray-100 text-gray-700 py-2 px-3 rounded-lg font-medium text-sm hover:bg-gray-200 flex-1"><i class="fa-solid fa-check mr-2"></i>Yes</button>
        <button data-s="s4" data-v="NO"  class="bg-gray-100 text-gray-700 py-2 px-3 rounded-lg font-medium text-sm hover:bg-gray-200 flex-1"><i class="fa-solid fa-times mr-2"></i>No</button>
      </div>`) +
    // S5: Marcador exacto
    card(5,8,`<p class="text-lg font-medium text-gray-900 mb-3">Predict the correct score</p>
      <div class="space-y-3">
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="flex items-center justify-center gap-4">
            <div class="text-center">
              <div class="text-xs text-gray-600 mb-1">${hName}</div>
              <div class="flex items-center gap-2">
                <button class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-gray-600 hover:bg-gray-300" onclick="adjScore('home',-1)"><i class="fa-solid fa-minus text-xs"></i></button>
                <div id="home-score" class="w-12 h-12 bg-white border-2 border-primary rounded-lg flex items-center justify-center text-xl font-bold text-primary">0</div>
                <button class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-gray-600 hover:bg-gray-300" onclick="adjScore('home',1)"><i class="fa-solid fa-plus text-xs"></i></button>
              </div>
            </div>
            <div class="text-2xl font-bold text-gray-400">:</div>
            <div class="text-center">
              <div class="text-xs text-gray-600 mb-1">${aName}</div>
              <div class="flex items-center gap-2">
                <button class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-gray-600 hover:bg-gray-300" onclick="adjScore('away',-1)"><i class="fa-solid fa-minus text-xs"></i></button>
                <div id="away-score" class="w-12 h-12 bg-white border-2 border-primary rounded-lg flex items-center justify-center text-xl font-bold text-primary">0</div>
                <button class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-gray-600 hover:bg-gray-300" onclick="adjScore('away',1)"><i class="fa-solid fa-plus text-xs"></i></button>
              </div>
            </div>
          </div>
        </div>
        <div>
          <div class="text-sm text-gray-600 mb-2">Quick picks:</div>
          <div class="grid grid-cols-6 gap-2">
            ${["0-0","1-0","2-0","0-1","1-1","2-1","0-2","1-2","3-0","3-1","2-2","0-3"]
              .map(s=>{const [x,y]=s.split("-");return `<button class="bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm py-1.5 rounded" onclick="quickScore(${x},${y})">${s}</button>`;})
              .join("")}
          </div>
        </div>
      </div>`);

  // Wire de botones de s1..s4
  grid.querySelectorAll('button[data-s]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const st = b.dataset.s;
      b.parentElement.querySelectorAll(`button[data-s="${st}"]`)
        .forEach(x=>x.classList.remove('!bg-primary','!text-white'));
      b.classList.add('!bg-primary','!text-white');
      picks[st] = b.dataset.v;
      updateCompleted();
    });
  });
}

// Control del score (s5)
function adjScore(side,delta){ score[side] = Math.max(0, score[side] + delta); syncScore(); }
function quickScore(h,a){ score.home = h; score.away = a; syncScore(); }
function syncScore(){
  const hs = el('home-score'), as = el('away-score');
  if (hs) hs.textContent = score.home;
  if (as) as.textContent = score.away;
  picks['s5'] = `${score.home}-${score.away}`;
  updateCompleted();
}
function updateCompleted(){
  el('completed-counter').textContent = `${Object.keys(picks).length}/5`;
}

function resetTicketFormForNextEntry(){
  picks = {};
  score = { home: 0, away: 0 };
  updateCompleted();
  if (selectedMatch) {
    renderPredictionsForDB(selectedMatch);
    const banner = el('error-banner');
    if (banner) banner.classList.add('hidden');
  }
}

async function refreshMatchTicketsAfterSubmit(matchId){
  const id = Number(matchId);
  if (!Number.isFinite(id)) return;
  try {
    const { data, error } = await sb.rpc('get_match_tickets_with_picks', { p_match_id: id });
    if (error) {
      console.warn('[refreshMatchTicketsAfterSubmit]', error);
      return;
    }
    const normalized = (data || []).map(mapTicketRpcRowToUI);
    setMatchTickets(id, normalized);
    renderMatches();
    renderResults();
  } catch (err) {
    console.warn('[refreshMatchTicketsAfterSubmit]', err);
  }
}

// Modal de √©xito
function openSuccessModal(ticketId){
  const m = el('success-modal');
  el('success-desc').textContent = ticketId
    ? `Ticket #${ticketId} saved. Good luck! ‚öΩÔ∏è`
    : `Your predictions were saved successfully.`;
  m.classList.remove('hidden'); m.classList.add('flex');
}
function closeSuccessModal(){
  const m = el('success-modal'); m.classList.add('hidden'); m.classList.remove('flex');
}
el('success-goto-results')?.addEventListener('click', ()=>{
  closeSuccessModal(); try { showView('results'); } catch(_) {} closeTicket();
});
el('success-close')?.addEventListener('click', ()=>{ closeSuccessModal(); closeTicket(); });

// Click del CTA principal ‚ÄúSubmit Ticket‚Äù
el('submit-ticket').addEventListener('click', async ()=>{
  if (!selectedMatch) return;

  // Completo 5/5
  if (Object.keys(picks).length < 5) {
    el('error-banner').classList.remove('hidden');
    setTimeout(()=>el('error-banner').classList.add('hidden'), 3000);
    return;
  }

  // Sesi√≥n requerida
  const { data: { session } } = await sb.auth.getSession();
  if (!session?.user) {
    // preserva picks para tu flujo de login, si lo usas:
    window.pendingSubmit = { matchId: selectedMatch.id, picksSnapshot: { ...picks } };
    try { openAuthFlow('signup'); } catch(_) {}
    return;
  }

  // Confirmaci√≥n previa
  openReviewModal();
});

// Review modal (pre-confirm)
function openReviewModal(){
  const r = el('review-modal');
  const list = el('review-list');
  const h = selectedMatch.home_team || 'Home';
  const a = selectedMatch.away_team || 'Away';
  const mapS1 = { HOME: h, DRAW: 'Draw', AWAY: a };
  list.innerHTML = `
    <div><b>Who wins:</b> ${mapS1[picks.s1] || '-'}</div>
    <div><b>BTTS:</b> ${picks.s2 || '-'}</div>
    <div><b>Over 2.5:</b> ${picks.s3 || '-'}</div>
    <div><b>Red card:</b> ${picks.s4 || '-'}</div>
    <div><b>Correct score:</b> ${picks.s5 || '-'}</div>`;
  r.classList.remove('hidden'); r.classList.add('flex');
}
el('cancel-submit').addEventListener('click', ()=>{
  el('review-modal').classList.add('hidden'); el('review-modal').classList.remove('flex');
});

// Confirmaci√≥n final ‚Üí RPC submit_ticket
el('confirm-submit').addEventListener('click', async ()=>{
  // Cerrar review
  el('review-modal').classList.add('hidden'); el('review-modal').classList.remove('flex');

  if (!selectedMatch) { showToast('No match selected'); return; }

  // Re-check lock (por si lleg√≥ al l√≠mite en este momento)
  const now  = new Date();
  const lock = new Date(selectedMatch.lock_time);
  if (now >= lock) {
    showToast('Locked while you were reviewing. Try another match.');
    closeTicket();
    try { showView('results'); } catch(_) {}
    return;
  }

  if (isSubmittingTicket) return;
  isSubmittingTicket = true;

  try {
    // Enviar al RPC transaccional
    const { data: ticketId, error } = await sb.rpc('submit_ticket', {
      p_match_id: selectedMatch.id,
      p_s1: picks.s1, p_s2: picks.s2, p_s3: picks.s3, p_s4: picks.s4, p_s5: picks.s5
    });

    if (error) {
      console.error('[submit_ticket][error]', error);
      showToast('Could not submit your ticket.');
      return;
    }

    const currentMatchId = selectedMatch?.id;
    if (Number.isFinite(Number(currentMatchId))) {
      await refreshMatchTicketsAfterSubmit(currentMatchId);
    }
    resetTicketFormForNextEntry();
    openSuccessModal(ticketId || null);
  } catch (e) {
    console.error(e);
    showToast('Could not submit your ticket.');
  } finally {
    isSubmittingTicket = false;
  }
});
	
/* ===== AUTH (UI) ===== */
const auth={root:document.getElementById('auth-flow'),tabs:[...document.querySelectorAll('.auth-tab')],forms:{signin:document.getElementById('form-signin'),signup:document.getElementById('form-signup'),reset:document.getElementById('form-reset')},
  setMode(mode){this.tabs.forEach(t=>{const a=t.dataset.tab===mode;t.classList.toggle('text-primary',a);t.classList.toggle('border-primary',a);t.classList.toggle('border-b-2',a);t.classList.toggle('text-gray-500',!a);t.classList.toggle('border-transparent',!a)});Object.entries(this.forms).forEach(([k,f])=>f.classList.toggle('hidden',k!==mode));document.getElementById('auth-subtitle').textContent=mode==='signin'?'Daily football predictions game':mode==='signup'?'Join the daily football prediction game':'Reset your password';},
  open(m='signin'){this.setMode(m);this.root.classList.remove('hidden');this.root.classList.add('flex')},close(){this.root.classList.add('hidden');this.root.classList.remove('flex')}
};
function openAuthFlow(m='signin'){returnView = currentView; auth.open(m)}
auth.tabs.forEach(t=>t.addEventListener('click',()=>auth.setMode(t.dataset.tab)));
document.querySelectorAll('[data-jump]').forEach(b=>b.addEventListener('click',()=>auth.setMode(b.dataset.jump)));
document.querySelectorAll('.toggle-pass').forEach(btn=>btn.addEventListener('click',()=>{const input=document.querySelector(btn.dataset.toggle); if(!input) return; input.type=input.type==='password'?'text':'password'; btn.innerHTML=input.type==='password'?'<i class="fa-regular fa-eye"></i>':'<i class="fa-regular fa-eye-slash"></i>'; }));
auth.forms.signin.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const email = document.getElementById('si-email').value.trim();
  const pass  = document.getElementById('si-pass').value;
  const { error } = await sb.auth.signInWithPassword({ email, password: pass });
  if (error) { showToast(error.message || 'Sign in failed'); return; }
  auth.close();
  showView(returnView || currentView);
  returnView = null;
});
auth.forms.signup.addEventListener('submit', async (e) => {
  e.preventDefault();

  const $u = document.getElementById('su-username');
  const $e = document.getElementById('su-email');
  const $p = document.getElementById('su-pass');
  const $c = document.getElementById('su-confirm');
  const $t = document.getElementById('su-terms');
  const btn = document.getElementById('su-submit');
  const spn = document.getElementById('su-spinner');

  // Limpia errores UI
  ['err-su-username','err-su-email','err-su-pass','err-su-confirm','err-su-terms']
    .forEach(id => document.getElementById(id).classList.add('hidden'));
  [$u,$e,$p,$c].forEach(i => i.classList.remove('is-invalid'));

  // Validaciones
  const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test($e.value.trim());
  const passOk  = /^(?=.*[0-9])(?=.*[^A-Za-z0-9]).{8,}$/.test($p.value);
  const userOk  = $u.value.trim().length >= 3 && $u.value.trim().length <= 20;
  const matchOk = $p.value === $c.value;
  const termsOk = $t.checked;

  if (!userOk)  { $u.classList.add('is-invalid'); document.getElementById('err-su-username').classList.remove('hidden'); }
  if (!emailOk){ $e.classList.add('is-invalid'); document.getElementById('err-su-email').classList.remove('hidden'); }
  if (!passOk) { $p.classList.add('is-invalid'); document.getElementById('err-su-pass').classList.remove('hidden'); }
  if (!matchOk){ $c.classList.add('is-invalid'); document.getElementById('err-su-confirm').classList.remove('hidden'); }
  if (!termsOk){ document.getElementById('err-su-terms').classList.remove('hidden'); }
  if (!(userOk && emailOk && passOk && matchOk && termsOk)) return;

  btn.disabled = true; spn.classList.remove('hidden');

  try {
    const username = $u.value.trim();
    const email    = $e.value.trim();
    const pass     = $p.value;

    const { data, error } = await sb.auth.signUp({
      email,
      password: pass,
      options: { data: { username } }
    });
    if (error) throw error;

    // Guarda credenciales para auto-login luego de "Continuar"
    try {
      localStorage.setItem('habla_signup_creds', JSON.stringify({ email, password: pass }));
    } catch {}

    // Mostrar banner ‚ÄúCheck your email‚Ä¶‚Äù
    const banner = document.getElementById('su-verify-banner');
    if (banner) banner.classList.remove('hidden');

    // Abrimos wizard (completa perfil); no escribe si no hay sesi√≥n (RLS)
    const uid = data?.user?.id || null;
    openProfileWizard({ userId: uid, email });

    // Cierra modal principal
    auth.close();
  } catch (err) {
    showToast(err?.message || 'Sign up failed');
  } finally {
    btn.disabled = false; spn.classList.add('hidden');
  }
});
	
auth.forms.reset.addEventListener('submit', async (e)=>{e.preventDefault();
  const email = document.getElementById('re-email').value.trim();
  const { error } = await sb.auth.resetPasswordForEmail(email, {
    redirectTo: window.location.origin // cambia si usas ruta /auth/callback
  });
  if (error) { showToast(error.message || 'Could not send reset link'); return; }
  showToast('Reset link sent. Check your inbox.');
});
document.getElementById('rw-open-signin')?.addEventListener('click',()=>openAuthFlow('signin'));
document.getElementById('rw-open-signup')?.addEventListener('click',()=>openAuthFlow('signup'));
document.getElementById('btn-guest-signin')?.addEventListener('click', ()=>{
  isGuest = true;
  localStorage.setItem('habla_guest', 'true');
  auth.close(); headerAuth(); renderRewards(); renderAccount();
  // Volver a donde est√°bamos
  showView(returnView || currentView);
  returnView = null;
  showToast('Continuing as guest');
});
document.getElementById('btn-guest-signup')?.addEventListener('click', ()=>{
  isGuest = true;
  localStorage.setItem('habla_guest', 'true');
  auth.close(); headerAuth(); renderRewards(); renderAccount();
  // Volver a donde est√°bamos
  showView(returnView || currentView);
  returnView = null;
  showToast('Continuing as guest');
});

/* ===== NAV / ROUTING ===== */
function showView(view){
  // Cierra cualquier overlay/drawer que pudiera bloquear UI
  try { closeTicket(); } catch(_) {}
  try { closeResultsDrawer(); } catch(_) {}
  try { auth.close(); } catch(_) {}
  el('overlay').classList.add('pointer-events-none');
  el('overlay').classList.remove('opacity-100');

  const m=el('matches-section'), r=el('results-section'), rw=el('rewards-section'), ac=el('account-section');
  m.classList.toggle('hidden', view!=='matches');
  r.classList.toggle('hidden', view!=='results');
  rw.classList.toggle('hidden', view!=='rewards');
  ac.classList.toggle('hidden', view!=='account');

  ['nav-matches','nav-results','nav-rewards','nav-account'].forEach(id=>{
    const b=el(id); if(!b) return;
    const active = id === ('nav-' + view);
    b.classList.toggle('text-primary', active);
    b.classList.toggle('font-semibold', active);
  });

  if(view==='matches') renderMatches();
  if(view==='results') renderResults();
  if(view==='rewards') renderRewards();
  if(view==='account') renderAccount();
  currentView = view;
}
                                                                                                                                                  
document.getElementById('nav-matches').addEventListener('click',()=>showView('matches'));
document.getElementById('nav-results').addEventListener('click',()=>showView('results'));
document.getElementById('nav-rewards').addEventListener('click',()=>showView('rewards'));
document.getElementById('brand-home').addEventListener('click',()=>showView('matches'));
document.getElementById('nav-account').addEventListener('click',()=>showView('account'));
                                                                                                                                                    
/* ===== REWARDS / REDEEM STORE (NUEVO) ===== */

/** Cat√°logo base (puedes mover a DB cuando quieras) */
const STORE_ITEMS = [
  {
    id: 'IPH14-128-BLK', sku: 'IPH14-128-BLK', name: 'iPhone 14 128GB (Black)',
    category: 'phones', cost: 3200, stock: 3, type: 'physical',
    img: 'https://images.unsplash.com/photo-1603899122830-c1fc36b73455?q=80&w=1200&auto=format&fit=crop',
    desc: 'Equipo nuevo, sellado. Garant√≠a oficial Apple. Env√≠o nacional.',
    meta: 'Processing 1‚Äì3 business days ‚Ä¢ Limited qty'
  },
  {
    id: 'MBP-13-M2', sku: 'MBP-13-M2', name: 'MacBook Pro 13" M2 8/256',
    category: 'laptops', cost: 5200, stock: 2, type: 'physical',
    img: 'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?q=80&w=1200&auto=format&fit=crop',
    desc: 'Laptop nueva con boleta. Env√≠o asegurado y tracking.',
    meta: 'Processing 1‚Äì3 business days ‚Ä¢ Signature required'
  },
  {
    id: 'PS5-SLIM', sku: 'PS5-SLIM', name: 'PlayStation 5 Slim',
    category: 'consoles', cost: 3800, stock: 5, type: 'physical',
    img: 'https://images.unsplash.com/photo-1606813907291-76a360df2d72?q=80&w=1200&auto=format&fit=crop',
    desc: 'Consola nueva. Incluye 1 control.',
    meta: 'Processing 1‚Äì3 business days ‚Ä¢ Limited qty'
  },
  {
    id: 'XBOX-SERIES-S', sku: 'XBOX-S', name: 'Xbox Series S',
    category: 'consoles', cost: 2200, stock: 6, type: 'physical',
    img: 'https://images.unsplash.com/photo-1605901309584-818e25960a8b?q=80&w=1200&auto=format&fit=crop',
    desc: 'Edici√≥n est√°ndar. Garant√≠a de fabricante.',
    meta: 'Processing 1‚Äì3 business days'
  },
  {
    id: 'AMZ-100', sku: 'AMZ-100', name: 'Gift Card Amazon US ‚Äì $100',
    category: 'giftcards', cost: 550, stock: 40, type: 'digital',
    img: 'https://images.unsplash.com/photo-1585386959984-a41552231664?q=80&w=1200&auto=format&fit=crop',
    desc: 'Entrega por email. Solo para cuentas US.',
    meta: 'Digital delivery ‚Ä¢ Usually instant'
  },
  {
    id: 'PSN-50', sku: 'PSN-50', name: 'PlayStation Store ‚Äì $50',
    category: 'giftcards', cost: 290, stock: 35, type: 'digital',
    img: 'https://images.unsplash.com/photo-1585247226801-bc613c441316?q=80&w=1200&auto=format&fit=crop',
    desc: 'C√≥digo digital v√≠a email.',
    meta: 'Digital delivery ‚Ä¢ Usually instant'
  },
  {
    id: 'AIRPODS-3', sku: 'AIRPODS-3', name: 'AirPods (3rd gen.)',
    category: 'accessories', cost: 1100, stock: 10, type: 'physical',
    img: 'https://images.unsplash.com/photo-1518449037230-8f6cfb0f7e8a?q=80&w=1200&auto=format&fit=crop',
    desc: 'Nuevos, sellados.',
    meta: 'Processing 1‚Äì3 business days'
  }
];

/** Mini ‚ÄúDB‚Äù de √≥rdenes del usuario actual (en producci√≥n: tabla orders) */
let ORDERS = []; // [{id, itemId, cost, type, status, created_at, detail:{...}}]

/** Render principal de la tienda */
function renderRewards(){
  // balance box
  el('rewards-balance').textContent = (isLoggedIn() ? lukasBalance : 0).toLocaleString() + ' Lukas';
  el('rewards-streak').textContent  = isLoggedIn() ? userStreak : 0;

  const ticketsPlayed = isLoggedIn() ? historyData.length : 0;
  const lifetime = isLoggedIn() ? historyData.reduce((a,h)=>a+h.lukas,0) : 0;
  el('rw-lifetime').textContent = lifetime;
  el('rw-tickets').textContent = ticketsPlayed;
  const avgRank = isLoggedIn()
    ? Math.round(historyData.reduce((a,h)=>a+(h.rank/h.total),0)/historyData.length*100)
    : 0;
  el('rw-avg').textContent = isLoggedIn() ? (`#${Math.max(1, Math.round(avgRank))}`) : '‚Äî';

  // filtros
  bindStoreFilters();
  drawStoreGrid();
}

/** Tarjeta de producto */
function cardHTML(it){
  const affordable = lukasBalance >= it.cost && isLoggedIn();
  const disabled = !affordable || it.stock <= 0;
  const badge = it.type === 'digital' ? 'Digital' : 'Physical';
  return `
    <div class="border rounded-2xl bg-white overflow-hidden hover:shadow-md transition">
      <div class="relative">
        <img src="${it.img}" class="w-full h-40 object-cover" alt="">
        <span class="absolute top-2 left-2 text-[11px] px-2 py-1 rounded-full ${it.type==='digital'?'bg-sky-600':'bg-emerald-600'} text-white">${badge}</span>
        ${it.stock<=0?'<span class="absolute top-2 right-2 text-[11px] px-2 py-1 rounded-full bg-gray-600 text-white">Out of stock</span>':''}
      </div>
      <div class="p-3">
        <div class="text-xs text-gray-500">${it.sku}</div>
        <div class="font-semibold leading-tight">${it.name}</div>
        <div class="mt-1 flex items-center justify-between">
          <span class="text-sm px-2 py-0.5 rounded bg-amber-100 text-amber-800 font-semibold">${it.cost.toLocaleString()} Lukas</span>
          <span class="text-[11px] text-gray-500">${it.stock} left</span>
        </div>
        <div class="mt-3 grid grid-cols-2 gap-2">
          <button data-prd="${it.id}" class="px-3 py-2 border rounded-lg text-sm hover:bg-gray-50">Details</button>
          <button data-buy="${it.id}" class="px-3 py-2 rounded-lg text-sm text-white ${disabled?'bg-gray-300 cursor-not-allowed':'bg-primary hover:bg-emerald-600'}">Redeem</button>
        </div>
      </div>
    </div>`;
}

/** Bind + dibujo de grid con filtros */
function bindStoreFilters(){
  const inputs = ['flt-category','flt-sort','flt-max','flt-q'];
  inputs.forEach(id=>{
    el(id)?.removeEventListener?.('input', drawStoreGrid);
    el(id)?.removeEventListener?.('change', drawStoreGrid);
    el(id)?.addEventListener?.('input', drawStoreGrid);
    el(id)?.addEventListener?.('change', drawStoreGrid);
  });
  el('flt-clear')?.addEventListener('click', ()=>{
    el('flt-category').value=''; el('flt-sort').value='popular'; el('flt-max').value=''; el('flt-q').value='';
    drawStoreGrid();
  });
  // botones superiores
  el('rewards-cta-matches').onclick = ()=>showView('matches');
  el('open-orders').onclick = openOrdersModal;
}

function drawStoreGrid(){
  const cat = el('flt-category').value;
  const sort = el('flt-sort').value;
  const max = Number(el('flt-max').value||0);
  const q = (el('flt-q').value||'').toLowerCase();

  let arr = [...STORE_ITEMS];

  if (cat) arr = arr.filter(i=>i.category===cat);
  if (max>0) arr = arr.filter(i=>i.cost<=max);
  if (q) arr = arr.filter(i=> (i.name+i.sku).toLowerCase().includes(q));

  if (sort==='low') arr.sort((a,b)=>a.cost-b.cost);
  if (sort==='high') arr.sort((a,b)=>b.cost-a.cost);
  if (sort==='new') arr.sort((a,b)=> (a.id<b.id?1:-1)); // proxy simple
  // popular: como est√°

  const grid = el('store-grid');
  grid.innerHTML = arr.map(cardHTML).join('') || `<div class="col-span-full text-center text-sm text-gray-500 py-8">No items match your filters.</div>`;
  el('store-count').textContent = `${arr.length} items`;

  // eventos
  grid.querySelectorAll('[data-prd]').forEach(b=> b.onclick = ()=> openProductModal(b.dataset.prd));
  grid.querySelectorAll('[data-buy]').forEach(b=> b.onclick = ()=> startRedeemFlow(b.dataset.buy));
}

/** Product Detail modal */
let _selectedItem = null;
function openProductModal(id){
  const it = STORE_ITEMS.find(x=>x.id===id);
  if(!it) return;
  _selectedItem = it;
  el('prd-img').src = it.img;
  el('prd-sku').textContent = it.sku;
  el('prd-name').textContent = it.name;
  el('prd-desc').textContent = it.desc;
  el('prd-cost').textContent = `${it.cost.toLocaleString()} Lukas`;
  el('prd-stock').textContent = `${it.stock>0?it.stock+' left':'Out of stock'}`;
  el('prd-meta').textContent = it.meta || '';
  const can = isLoggedIn() && lukasBalance>=it.cost && it.stock>0;
  const btn = el('prd-redeem');
  btn.disabled = !can;
  showModal('prd-modal');
}
el('prd-close')?.addEventListener('click',()=>hideModal('prd-modal'));
el('prd-cancel')?.addEventListener('click',()=>hideModal('prd-modal'));
el('prd-redeem')?.addEventListener('click',()=>{
  hideModal('prd-modal');
  if(_selectedItem) startRedeemFlow(_selectedItem.id);
});

/** Checkout modal (anti-reclamos: validaciones fuertes) */
function startRedeemFlow(id){
  const it = STORE_ITEMS.find(x=>x.id===id);
  if(!it) return;

  // Pre-checks (minimiza reclamos)
  if (!isLoggedIn() || isGuest) { openAuthFlow('signin'); return; }
  if (lukasBalance < it.cost) { showToast('Not enough Lukas'); return; }
  const emailVerified = !!(currentUser && currentUser.email_confirmed_at);
  if (!emailVerified) { showToast('Please verify your email first'); return; }
  if (!isProfileComplete()) { showToast('Complete your profile (18+, name, DOB, email)'); return; }
  if (it.stock<=0) { showToast('Out of stock'); return; }

  // Pintar checkout
  el('chk-item').textContent = `${it.name} (${it.sku})`;
  el('chk-cost').textContent = `${it.cost.toLocaleString()} Lukas`;
  el('chk-spend').textContent = `${it.cost.toLocaleString()} Lukas`;
  el('chk-ack').checked = false;
  el('chk-error').classList.add('hidden');
  // limpiar campos
  ['chk-name','chk-dni','chk-phone','chk-city','chk-address','chk-email'].forEach(id=>{const n=el(id); if(n) n.value='';});
  // mostrar secciones seg√∫n tipo
  el('chk-ship-box').classList.toggle('hidden', it.type!=='physical');
  el('chk-digital-box').classList.toggle('hidden', it.type!=='digital');

  // enlazar T&C
  el('chk-terms-link').onclick = (e)=>{ e.preventDefault(); try{ openTerms(); }catch{} };

  // confirmar
  const confirm = el('chk-confirm');
  confirm.disabled = true;
  const checkEnable = ()=>{
    const ack = el('chk-ack').checked;
    if(it.type==='physical'){
      const ok = ['chk-name','chk-dni','chk-phone','chk-city','chk-address'].every(id=>(el(id).value||'').trim());
      confirm.disabled = !(ack && ok);
    } else {
      const em = (el('chk-email').value||'').trim();
      const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(em);
      confirm.disabled = !(ack && emailOk);
    }
  };
  ['chk-ack','chk-name','chk-dni','chk-phone','chk-city','chk-address','chk-email']
    .forEach(id=> el(id)?.addEventListener('input', checkEnable));
  checkEnable();

  // handlers
  confirm.onclick = async ()=>{
    // revalidar por si cambi√≥ algo
    if (confirm.disabled) return;

    // ‚ÄúCrear‚Äù orden (en producci√≥n: insert en tabla orders con RLS)
    const order = {
      id: 'ORD-' + Math.random().toString(36).slice(2,8).toUpperCase(),
      itemId: it.id,
      cost: it.cost,
      type: it.type,
      status: (it.type==='digital' ? 'processing' : 'pending_shipment'),
      created_at: new Date().toISOString(),
      detail: it.type==='physical'
        ? {
            name: el('chk-name').value.trim(),
            dni: el('chk-dni').value.trim(),
            phone: el('chk-phone').value.trim(),
            city: el('chk-city').value.trim(),
            address: el('chk-address').value.trim()
          }
        : { email: el('chk-email').value.trim() }
    };

    // Debita Lukas y stock (optimista)
    lukasBalance -= it.cost;
    it.stock = Math.max(0, it.stock - 1);
    ORDERS.unshift(order);
    headerAuth();
    drawStoreGrid();
    hideModal('chk-modal');

    // Notifica (email opcional si ya tienes edge function configurada)
    try { await sendConfirmationEmail(currentUser.email, currentUser.user_metadata?.username || 'Player', 'Espa√±ol'); } catch {}

    showToast(`Order ${order.id} created`);
  };

  el('chk-cancel').onclick = ()=> hideModal('chk-modal');

  showModal('chk-modal');
}

/** √ìrdenes */
function openOrdersModal(){
  const box = el('orders-list');
  if (!ORDERS.length){
    box.innerHTML = `<div class="py-6 text-center text-sm text-gray-600">No redemptions yet.</div>`;
  } else {
    box.innerHTML = ORDERS.map(o=>{
      const it = STORE_ITEMS.find(x=>x.id===o.itemId);
      return `<div class="py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="${it?.img||''}" class="w-14 h-14 object-cover rounded-lg border">
          <div>
            <div class="text-sm font-semibold">${it?.name||o.itemId}</div>
            <div class="text-xs text-gray-500">${o.id} ‚Ä¢ ${new Date(o.created_at).toLocaleString()}</div>
          </div>
        </div>
        <div class="text-right">
          <div class="text-sm">${o.cost.toLocaleString()} Lukas</div>
          <div class="text-xs ${o.status.includes('pending')?'text-amber-700':'text-emerald-700'}">${o.status.replace('_',' ')}</div>
        </div>
      </div>`;
    }).join('');
  }
  showModal('orders-modal');
}
el('orders-close')?.addEventListener('click', ()=> hideModal('orders-modal'));

/** Helpers modales (reusa clases existentes) */
function showModal(id){ const m=el(id); m.classList.remove('hidden'); m.classList.add('flex'); }
function hideModal(id){ const m=el(id); m.classList.add('hidden'); m.classList.remove('flex'); }

/* ===== REDEEM MODAL LOGIC ===== */
function openRedeemModal(){
  if(!isLoggedIn() || isGuest){ openAuthFlow('signin'); return; }
  if(lukasBalance < 100){ showToast('You need at least 100 Lukas to redeem'); return; }

  const modal = el('redeem-modal');
  const bal   = el('redeem-balance');
  const amt   = el('redeem-amount');

  if (!modal || !bal || !amt) {
    showToast('Redeem modal not available');
    return;
  }

  bal.textContent = `${lukasBalance.toLocaleString()} Lukas`;
  amt.value = Math.min(lukasBalance, 100);
  updateRedeemUI();
  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

function closeRedeemModal(){
  const m = el('redeem-modal');
  if (!m) return;
  m.classList.add('hidden');
  m.classList.remove('flex');
}

function updateRedeemUI(){
  const amountNode = el('redeem-amount');
  if (!amountNode) return;

  const solesNode  = el('redeem-soles');
  const confirmBtn = el('redeem-confirm');
  const errNode    = el('redeem-error');

  const amt = parseInt(amountNode.value || 0, 10);
  if (solesNode)  solesNode.textContent = 'S/ ' + (isNaN(amt) ? 0 : amt).toLocaleString();

  const valid = amt >= 100 && amt <= lukasBalance;
  if (confirmBtn) confirmBtn.disabled = !valid;

  if (errNode){
    if(!valid){
      errNode.textContent = (amt < 100) ? 'Minimum redeem is 100 Lukas.' : 'Amount exceeds your balance.';
      errNode.classList.remove('hidden');
    } else {
      errNode.classList.add('hidden');
    }
  }
}

/* Eventos: √öNICA fuente de verdad (sin duplicados) */
el('rewards-cta-redeem')?.addEventListener('click', openRedeemModal);
el('redeem-close')?.addEventListener('click', closeRedeemModal);
el('redeem-close-2')?.addEventListener('click', closeRedeemModal);
el('redeem-amount')?.addEventListener('input', updateRedeemUI);
el('redeem-confirm')?.addEventListener('click', ()=>{
  const amountNode = el('redeem-amount');
  if (!amountNode) return;
  const amt = parseInt(amountNode.value || 0, 10);
  if(!(amt >= 100 && amt <= lukasBalance)) return;
  // 1 Luka = 1 Sol
  lukasBalance -= amt;
  headerAuth();
  renderRewards();
  closeRedeemModal();
  showToast(`Redeemed ${amt} Lukas for S/ ${amt}`);
});

// Bot√≥n "Go to Redeem Store" (demo)
el('rewards-cta-store')?.addEventListener('click', ()=>{
  // Aqu√≠ podr√≠as redirigir a /store; por ahora mostramos un toast
  showToast('Opening Redeem Store‚Ä¶');
});


/* ===== ACCOUNT PAGE (vertical) ===== */
function calcAgeFromInput(v){ if(!v) return 0; const d=new Date(v); const t=Date.now()-d.getTime(); return Math.abs(new Date(t).getUTCFullYear()-1970); }
function validateAge(){
  const age = calcAgeFromInput(el('acc-dob').value);
  const ok = age >= 18 && el('acc-18').checked;
  el('acc-age-error').classList.toggle('hidden', ok);
  updateAccSaveState();
}
function openAvatarModal(){
  if(!accountEditMode) return;
  const g = el('avatar-grid');
  g.innerHTML = avatarLibrary.map(u=>`<button data-url="${u}" class="rounded-lg overflow-hidden border hover:ring-2 hover:ring-primary"><img src="${u}" class="w-full h-20 object-cover" alt=""></button>`).join('');
  g.querySelectorAll('button').forEach(b=> b.onclick = ()=>{ el('acc-avatar').src = b.dataset.url; closeAvatarModal(); updateAccSaveState(); });
  el('avatar-modal').classList.remove('hidden'); el('avatar-modal').classList.add('flex');
}
function closeAvatarModal(){ el('avatar-modal').classList.add('hidden'); el('avatar-modal').classList.remove('flex'); }

async function renderAccount(){
  // Gate: si no hay sesi√≥n
  if(!isLoggedIn()){
    el('account-guest')?.classList.remove('hidden');
    el('account-body')?.classList.add('hidden');
    el('acc-open-signin')?.addEventListener('click',()=>openAuthFlow('signin'));
    el('acc-open-signup')?.addEventListener('click',()=>openAuthFlow('signup'));
    return;
  }

  async function loadProfileFromDB(){
    if (!currentUser) return null;
    const { data, error } = await sb.from('profiles')
      .select('*')
      .eq('user_id', currentUser.id)
      .maybeSingle();
    if (error) { console.warn(error); return null; }
    return data;
  }

  el('account-guest')?.classList.add('hidden');
  el('account-body')?.classList.remove('hidden');

  const dbp = await loadProfileFromDB();
  const usernameFromAuth = currentUser?.user_metadata?.username || '';

  if (!dbp) {
    savedProfile = {
      avatar: avatarLibrary[2],
      fullname: '',
      team: 'Real Madrid',
      dob: '',
      is18: false,
      email: currentUser?.email || '',
      twofa: false,
      payoutMethod: 'Bank transfer (PEN)',
      payoutDetail: '',
      nEmail: true, nPush: true, lang: 'Espa√±ol', profilePublic: true
    };
  } else {
    savedProfile = {
      avatar: dbp.avatar_url || avatarLibrary[2],
      fullname: dbp.full_name || '',
      team: dbp.favorite_team || 'Real Madrid',
      dob: dbp.dob || '',
      is18: !!dbp.is_adult,
      email: currentUser?.email || '',
      twofa: !!dbp.twofa_enabled,
      payoutMethod: dbp.payout_method || 'Bank transfer (PEN)',
      payoutDetail: dbp.payout_detail || '',
      nEmail: dbp.notify_email ?? true,
      nPush:  dbp.notify_push  ?? true,
      lang: dbp.lang || 'Espa√±ol',
      profilePublic: dbp.profile_public ?? true
    };
  }

  // Pintar valores (incluye username solo-lectura)
  fillProfile(savedProfile);
  const uInput = document.getElementById('acc-username');
  if (uInput) uInput.value = usernameFromAuth;

  setAccountEditable(false);
  validateAge();

  // Banner completar perfil
  if(!el('acc-complete-banner')){
    const banner = document.createElement('div');
    banner.id = 'acc-complete-banner';
    banner.className = 'hidden bg-amber-50 border border-amber-200 text-amber-800 rounded-lg p-3 mb-4';
    banner.innerHTML = '<b>Complete your profile</b> to enable withdrawals and play.';
    const sec = el('account-section');
    sec.insertBefore(banner, el('account-body'));
  }
  el('acc-complete-banner').classList.toggle('hidden', isProfileComplete());

  // Verificaci√≥n de email
  paintEmailVerification();

  // === Handlers ===
  el('acc-edit')?.addEventListener('click', ()=> setAccountEditable(true));
  el('acc-cancel')?.addEventListener('click', ()=>{
    fillProfile(savedProfile);
    const u = document.getElementById('acc-username');
    if (u) u.value = usernameFromAuth;
    setAccountEditable(false);
    validateAge();
  });

  // Guardar (√∫nico bot√≥n v√°lido en el UI actual)
  const saveHandler = async ()=>{
    if(!accountEditMode) return;
    if(!isProfileComplete()){
      showToast('Please complete all required fields (18+).');
      return;
    }
    const p = readProfile();
    try {
      // Cambio de email
      if (p.email && p.email !== (currentUser?.email || '')) {
        const { error } = await sb.auth.updateUser({ email: p.email });
        if (error) throw error;
        showToast('Email updated. Please verify the new address.');
      }
      // Cambio de password (si se escribi√≥)
      if (el('acc-pass')?.value?.trim()) {
        const { error } = await sb.auth.updateUser({ password: el('acc-pass').value.trim() });
        if (error) throw error;
        el('acc-pass').value = '';
        showToast('Password updated.');
      }
      // Guardar en DB
      if (currentUser){
        const row = {
          user_id: currentUser.id,
          full_name: p.fullname,
          avatar_url: p.avatar,
          favorite_team: p.team,
          dob: p.dob,
          is_adult: p.is18,
          payout_method: p.payoutMethod,
          payout_detail: p.payoutDetail,
          notify_email: p.nEmail,
          notify_push:  p.nPush,
          lang: p.lang,
          profile_public: p.profilePublic
        };
        const { error } = await sb.from('profiles').upsert(row);
        if (error) throw error;
      }

      savedProfile = { ...p };
      setAccountEditable(false);
      paintEmailVerification();
      el('acc-complete-banner')?.classList.add('hidden');
      showToast('Account settings saved');
    } catch(err){
      console.error(err);
      showToast('Could not save profile');
    }
  };
  el('acc-save-top')?.addEventListener('click', saveHandler);

  // Re-evaluar Save al cambiar cualquier control
  const reval = ()=>{ validateAge(); updateAccSaveState(); };
  getAccountInputs().forEach(ctrl=>{
    ctrl.addEventListener('input', reval);
    ctrl.addEventListener('change', reval);
  });

  // Avatar modal
  el('acc-change-avatar')?.addEventListener('click', openAvatarModal);
  el('avatar-cancel')?.addEventListener('click', closeAvatarModal);

  // Reenviar verificaci√≥n
  el('acc-email-resend')?.addEventListener('click', async ()=>{
    const target = (readProfile().email || currentUser?.email || '').trim();
    if (!target) return;
    try {
      await sb.auth.resend({ type: 'signup', email: target });
      showToast('Verification email sent.');
    } catch {
      showToast('Could not resend email.');
    }
  });
}

// === Estado y helpers de edici√≥n/validaci√≥n (REEMPLAZO) ===
let accountEditMode = false;
let savedProfile = null;

function getAccountInputs(){
  // Solo inputs existentes (ya que removimos secciones)
  return el('account-body').querySelectorAll('input, select, textarea');
}

function setAccountEditable(on){
  accountEditMode = on;
  getAccountInputs().forEach(ctrl => { ctrl.disabled = !on; });

  const avatarBtn = el('acc-change-avatar');
  if (avatarBtn) avatarBtn.disabled = !on;

  // Toggle de botones
  el('acc-edit')?.classList.toggle('hidden', on);
  el('acc-cancel')?.classList.toggle('hidden', !on);

  // Mostrar/ocultar Save de arriba
  const saveTop = el('acc-save-top');
  if (saveTop) saveTop.classList.toggle('hidden', !on);

  updateAccSaveState();
}

function fillProfile(p){
  // Solo seteamos lo que existe en el DOM
  const setIf = (id, fn) => { const node = el(id); if (node) fn(node); };

  setIf('acc-avatar', n => n.src = p.avatar);
  setIf('acc-fullname', n => n.value = p.fullname || '');
  setIf('acc-team', n => n.value = p.team || 'Real Madrid');
  setIf('acc-dob', n => n.value = p.dob || '');
  setIf('acc-18', n => n.checked = !!p.is18);
  setIf('acc-email', n => n.value = p.email || '');
  setIf('acc-pass', n => n.value = '');

  // Campos eliminados: mantenemos valores en savedProfile (sin tocar DOM)
}

function readProfile(){
  // Leemos del DOM si existe; si no, devolvemos lo que ya ten√≠amos guardado
  const getVal = (id, def) => {
    const node = el(id);
    if (!node) return def;
    if (node.type === 'checkbox') return !!node.checked;
    return (node.value ?? '').trim();
  };

  return {
    avatar: el('acc-avatar')?.src || savedProfile?.avatar || '',
    fullname: getVal('acc-fullname', savedProfile?.fullname || ''),
    team: getVal('acc-team', savedProfile?.team || 'Real Madrid'),
    dob: getVal('acc-dob', savedProfile?.dob || ''),
    is18: !!(el('acc-18')?.checked ?? savedProfile?.is18 ?? false),
    email: getVal('acc-email', savedProfile?.email || ''),

    // Mantener lo previo (UI eliminada)
    payoutMethod: savedProfile?.payoutMethod ?? 'Bank transfer (PEN)',
    payoutDetail: savedProfile?.payoutDetail ?? '',
    nEmail: savedProfile?.nEmail ?? true,
    nPush: savedProfile?.nPush ?? true,
    lang: savedProfile?.lang ?? 'Espa√±ol',
    profilePublic: savedProfile?.profilePublic ?? true
  };
}

function isProfileComplete(){
  const ageOK = calcAgeFromInput(el('acc-dob')?.value) >= 18 && !!el('acc-18')?.checked;
  const required = [
    el('acc-fullname')?.value?.trim(),
    el('acc-team')?.value,
    el('acc-dob')?.value,
    el('acc-email')?.value?.trim(),
    el('acc-avatar')?.src
  ].every(Boolean);
  return ageOK && required;
}

function isProfileDirty(){
  if (!savedProfile) return false;
  const cur = readProfile();
  const keys = ['avatar','fullname','team','dob','is18','email'];
  return keys.some(k => String(cur[k]) !== String(savedProfile[k]));
}

function updateAccSaveState(){
  const enabled = accountEditMode && isProfileComplete() && isProfileDirty();

  // Habilitar Save de arriba
  const saveTop = el('acc-save-top');
  if (saveTop) saveTop.disabled = !enabled;
}

// Email verified badge (sin cambios, salvo que ya no dependemos de prefs eliminadas)
function paintEmailVerification(){
  const badge = el('acc-email-status');
  const resend = el('acc-email-resend');
  if (!badge) return;
  const verified = !!(currentUser && currentUser.email_confirmed_at);
  if (verified) {
    badge.className = 'status-pill bg-emerald-100 text-emerald-700';
    badge.innerHTML = '<span class="status-dot bg-emerald-600"></span> Verified';
    resend?.classList.add('hidden');
  } else {
    badge.className = 'status-pill bg-amber-100 text-amber-700';
    badge.innerHTML = '<span class="status-dot bg-amber-500"></span> Not verified';
    resend?.classList.remove('hidden');
  }
}

/* ===== PROFILE WIZARD (post‚ÄìSign Up) ‚Äî versi√≥n sin pasos ===== */
let pwState = { userId: null, email: '' };

/** Abre el wizard en una sola vista y deja solo validaci√≥n + navegaci√≥n */
function openProfileWizard(ctx = {}) {
  pwState = { userId: ctx.userId || null, email: ctx.email || '' };

  // Arranca el modal
  const m = document.getElementById('profile-wizard');
  m.classList.remove('hidden');
  m.classList.add('flex');

  // Oculta cualquier UI de pasos que pueda existir en HTML
  const stepPill = document.getElementById('pw-step');
  if (stepPill) stepPill.classList.add('hidden');
  const nextBtn = document.getElementById('pw-next');
  if (nextBtn) nextBtn.classList.add('hidden');

  // Back solo cierra el wizard
  const backBtn = document.getElementById('pw-back');
  if (backBtn) backBtn.classList.remove('hidden');

  // Enlaza validaci√≥n en vivo una sola vez
  wirePwLiveValidation();

  // Valida estado inicial (habilita/deshabilita Finish)
  validatePW();
}

function closeProfileWizard() {
  const m = document.getElementById('profile-wizard');
  m.classList.add('hidden');
  m.classList.remove('flex');
}

/** Valida los campos requeridos (nombre + 18+) y habilita/deshabilita Finish */
function validatePW() {
  // limpiar estados
  ['pw-fullname','pw-dob'].forEach(id => document.getElementById(id).classList.remove('is-invalid'));
  ['err-pw-fullname','pw-age-error'].forEach(id => document.getElementById(id).classList.add('hidden'));

  let ok = true;

  // Nombre obligatorio
  const $name = document.getElementById('pw-fullname');
  if (!$name.value.trim()) {
    ok = false;
    $name.classList.add('is-invalid');
    document.getElementById('err-pw-fullname').classList.remove('hidden');
  }

  // 18+
  const dob  = document.getElementById('pw-dob').value;
  const is18 = document.getElementById('pw-18').checked;
  const age  = (function(d){
    if(!d) return 0;
    const t = Date.now() - new Date(d).getTime();
    return Math.abs(new Date(t).getUTCFullYear() - 1970);
  })(dob);
  if (!(age >= 18 && is18)) {
    ok = false;
    document.getElementById('pw-age-error').classList.remove('hidden');
  }

  // Habilitar/Deshabilitar bot√≥n Finish
  const finishBtn = document.getElementById('pw-finish');
  if (finishBtn) finishBtn.disabled = !ok;

  return ok;
}

/** Enlaza listeners para validaci√≥n en vivo (se asegura de no duplicar) */
let _pwListenersWired = false;
function wirePwLiveValidation() {
  if (_pwListenersWired) return;
  const ids = ['pw-fullname', 'pw-dob', 'pw-18', 'pw-team', 'pw-lang', 'pw-n-email'];
  ids.forEach(id => {
    const node = document.getElementById(id);
    if (!node) return;
    const ev = (node.tagName === 'INPUT' && node.type === 'checkbox') ? 'change' : 'input';
    node.addEventListener(ev, validatePW);
  });
  _pwListenersWired = true;
}

// Bot√≥n Back ‚Üí cierra el wizard
const _pwBackBtn = document.getElementById('pw-back');
if (_pwBackBtn) {
  _pwBackBtn.onclick = () => {
    closeProfileWizard();
  };
}

// Bot√≥n Finish ‚Üí guarda en DB, registra onboarding y env√≠a correo de confirmaci√≥n
const _pwFinishBtn = document.getElementById('pw-finish');
if (_pwFinishBtn) {
  _pwFinishBtn.onclick = async () => {
    if (!validatePW()) return;

    const payload = {
      full_name: document.getElementById('pw-fullname').value.trim(),
      favorite_team: document.getElementById('pw-team').value,
      dob: document.getElementById('pw-dob').value,
      is_adult: document.getElementById('pw-18').checked,
      avatar_url: document.getElementById('pw-avatar').src,
      lang: document.getElementById('pw-lang').value,
      notify_email: document.getElementById('pw-n-email').checked
    };

    const userId    = pwState.userId || (currentUser?.id ?? null);
    const userEmail = (pwState.email && pwState.email.trim()) || (currentUser?.email ?? '');

    // Caso 1: NO hay sesi√≥n (email a√∫n no verificado) -> guardamos ‚Äúpendiente‚Äù
    if (!currentUser) {
      savePendingProfileToLocal({ userId, email: userEmail, payload });
      // Intento de reenv√≠o de verificaci√≥n (no bloquea)
      try { if (userEmail) await sb.auth.resend({ type: 'signup', email: userEmail }); } catch {}
      closeProfileWizard();
      openSignupCompleteModal(userEmail);
      return;
    }

    // Caso 2: S√≠ hay sesi√≥n -> upsert inmediato (ya no rompe RLS)
    try {
      const { error: upsertErr } = await sb.from('profiles').upsert({ user_id: currentUser.id, ...payload });
      if (upsertErr) throw upsertErr;

      // Log no bloqueante
      try { await logOnboardingSubmission(currentUser.id, payload); } catch {}

      // Email de confirmaci√≥n de onboarding (si consinti√≥ email)
      try { if (userEmail && payload.notify_email) await sendConfirmationEmail(userEmail, payload.full_name, payload.lang); } catch {}

      closeProfileWizard();
      openSignupCompleteModal(userEmail);
    } catch (err) {
      console.error(err);
      showToast('No se pudo guardar tu perfil. Intenta nuevamente.');
    }
  };
}

// Helpers para ‚Äúpendiente en localStorage‚Äù
function savePendingProfileToLocal(obj) {
  try { localStorage.setItem('habla_pw_pending', JSON.stringify(obj)); } catch {}
}

/** Selector de avatar dentro del wizard (reutiliza el modal existente) */
const _pwAvatarBtn = document.getElementById('pw-change-avatar');
if (_pwAvatarBtn) {
  _pwAvatarBtn.addEventListener('click', () => {
    const g = document.getElementById('avatar-grid');
    g.innerHTML = avatarLibrary.map(u =>
      `<button data-url="${u}" class="rounded-lg overflow-hidden border hover:ring-2 hover:ring-primary">
         <img src="${u}" class="w-full h-20 object-cover" alt="">
       </button>`).join('');
    g.querySelectorAll('button').forEach(b => b.onclick = () => {
      document.getElementById('pw-avatar').src = b.dataset.url;
      document.getElementById('avatar-modal').classList.add('hidden');
      document.getElementById('avatar-modal').classList.remove('flex');
      validatePW(); // por si dependes de tener avatar
    });
    const av = document.getElementById('avatar-modal');
    av.classList.remove('hidden');
    av.classList.add('flex');
  });
}

function openSignupCompleteModal(emailForHint){
  const m = el('signup-complete-modal');
  const hint = el('sc-email-hint');
  hint.textContent = emailForHint ? `Enviado a: ${emailForHint}` : '';
  m.classList.remove('hidden'); 
  m.classList.add('flex');
}

function closeSignupCompleteModal(){
  const m = el('signup-complete-modal');
  m.classList.add('hidden'); 
  m.classList.remove('flex');
}

// Bot√≥n "Continuar": auto-login + guardar perfil pendiente
el('sc-continue')?.addEventListener('click', async () => {
  closeSignupCompleteModal();

  // Intenta auto-login con las credenciales guardadas en sign up
  let creds = null;
  try { creds = JSON.parse(localStorage.getItem('habla_signup_creds') || 'null'); } catch {}

  if (creds?.email && creds?.password) {
    try {
      const { error } = await sb.auth.signInWithPassword({
        email: creds.email,
        password: creds.password
      });
      if (!error) {
        showToast('Welcome! You are now signed in.');
      }
    } catch (e) {
      // Si falla (p.e. no verific√≥ a√∫n), seguimos sin bloquear UX
    } finally {
      try { localStorage.removeItem('habla_signup_creds'); } catch {}
    }
  }

  // Volver a la vista anterior
  showView(returnView || currentView);
  returnView = null;
});

// Bot√≥n "Reenviar email"
el('sc-resend')?.addEventListener('click', async () => {
  try {
    const email = (pwState?.email && pwState.email.trim()) || (currentUser?.email ?? '');
    if (email) {
      await sb.auth.resend({ type: 'signup', email });
      showToast('Email reenviado. Revisa tu bandeja.');
    } else {
      showToast('No hay un correo para reenviar.');
    }
  } catch (e) {
    showToast('No se pudo reenviar el email.');
  }
});

/* ===== UTILS FOR RESULTS ===== */
function labelDateTime(d){const dt=new Date(d); const today=new Date(); today.setHours(0,0,0,0); const delta=Math.floor((dt - today)/86400000); const tag = delta===0?'Today':(delta===1?'Tomorrow':(delta===-1?'Yesterday':dt.toLocaleDateString([], {weekday:'short'}))); return `${tag} ${dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`;}
async function logOnboardingSubmission(userId, payload) {
  try {
    const { error } = await sb.from('onboarding_submissions').insert([{
      user_id: userId,
      full_name: payload.full_name,
      favorite_team: payload.favorite_team,
      dob: payload.dob,
      is_adult: payload.is_adult,
      avatar_url: payload.avatar_url,
      lang: payload.lang,
      notify_email: payload.notify_email
    }]);
    if (error) throw error;
  } catch (e) {
    console.warn('[logOnboardingSubmission]', e);
  }
}

async function sendConfirmationEmail(to, name, lang) {
  // Edge Function con guion BAJO: send_confirmation
  try {
    const { data, error } = await sb.functions.invoke('send_confirmation', {
      body: { to, name: name || 'Jugador/a', lang: lang || 'Espa√±ol' }
    });
    if (error) throw error;
    return data;
  } catch (err) {
    console.warn('[send_confirmation] failed:', err?.message || err);
    // No bloqueamos el flujo si falla el correo
    return null;
  }
}
	
/* ===== START ===== */
initAuth();        // establece currentUser/isGuest, y refresca UI
showView('matches');

/* EVENTS extra */
document.getElementById('rewards-cta-play').addEventListener('click',()=>showView('matches'));
</script>
<!-- Footer fijo (links) -->
<footer class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-50 h-14">
  <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between text-sm">
    <div class="flex items-center gap-4 text-gray-600">
      <a href="#" id="ft-terms" class="hover:text-gray-900">T√©rminos y Condiciones</a>
      <a href="#" id="ft-privacy" class="hover:text-gray-900">Privacidad</a>
      <a href="#" id="ft-about" class="hover:text-gray-900">About</a>
      <a href="#" id="ft-contact" class="hover:text-gray-900">Contacto</a>
    </div>
    <div class="text-gray-500">&copy; <span id="ft-year"></span> Habla! ‚Äî Todos los derechos reservados</div>
  </div>
</footer>
<script>
  // utilidades footer
  (function(){
    const y = document.getElementById('ft-year');
    if (y) y.textContent = new Date().getFullYear();
    // Reusa el modal de Terms existente
    document.getElementById('ft-terms')?.addEventListener('click', (e)=>{ e.preventDefault(); try{ openTerms(); }catch{} });
  })();
  // Stub no-op para evitar errores si a√∫n no tienes backend de emails:
  async function sendConfirmationEmail(email, name, lang) {
    console.info('[sendConfirmationEmail]', { email, name, lang });
    // Aqu√≠ podr√≠as integrar tu servicio real de correo
  }

  // Asegurar arranque de auth al cargar:
  if (typeof initAuth === 'function') {
    document.addEventListener('DOMContentLoaded', initAuth);
  }
</script>
<!-- PRODUCT DETAILS MODAL -->
<div id="prd-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-[85]">
  <div class="bg-white rounded-2xl w-full max-w-2xl p-6 shadow-xl relative">
    <button id="prd-close" class="absolute right-3 top-3 w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100" aria-label="Close">
      <i class="fa-solid fa-xmark text-gray-500"></i>
    </button>
    <div class="grid md:grid-cols-[1.1fr_.9fr] gap-4">
      <div>
        <img id="prd-img" class="w-full h-56 object-cover rounded-xl border" src="" alt="">
      </div>
      <div>
        <div class="text-xs text-gray-500" id="prd-sku"></div>
        <h3 id="prd-name" class="text-lg font-semibold"></h3>
        <div class="mt-1 text-sm text-gray-600" id="prd-desc"></div>
        <div class="mt-3 flex items-center gap-2">
          <span class="px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 text-xs font-semibold" id="prd-cost"></span>
          <span class="px-2 py-1 rounded-full bg-gray-100 text-gray-700 text-xs" id="prd-stock"></span>
        </div>
        <div class="mt-3 text-xs text-gray-600" id="prd-meta"></div>
        <div class="mt-4 flex gap-2">
          <button id="prd-redeem" class="flex-1 bg-primary text-white rounded-lg py-2 text-sm font-semibold disabled:opacity-40 disabled:cursor-not-allowed">
            Redeem with Lukas
          </button>
          <button id="prd-cancel" class="flex-1 border rounded-lg py-2 text-sm hover:bg-gray-50">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CHECKOUT / REDEEM MODAL -->
<div id="chk-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-[90]">
  <div class="bg-white rounded-2xl w-full max-w-xl p-6 shadow-xl">
    <h3 class="text-lg font-semibold">Confirm redemption</h3>
    <p class="text-sm text-gray-600">Review and confirm your details.</p>

    <div class="mt-4 space-y-3">
      <div class="p-3 rounded-lg bg-gray-50 border">
        <div class="text-xs text-gray-600">Selected reward</div>
        <div id="chk-item" class="text-sm font-semibold">‚Äî</div>
        <div id="chk-cost" class="text-xs text-gray-600"></div>
      </div>

      <!-- SHIPPING (shown only for physical) -->
      <div id="chk-ship-box" class="hidden border rounded-lg p-3">
        <div class="text-xs text-gray-600 mb-2">Shipping address (Peru)</div>
        <div class="grid grid-cols-2 gap-2">
          <input id="chk-name" class="border rounded-lg px-3 py-2" placeholder="Full name">
          <input id="chk-dni" class="border rounded-lg px-3 py-2" placeholder="DNI / CE">
          <input id="chk-phone" class="border rounded-lg px-3 py-2" placeholder="Phone">
          <input id="chk-city" class="border rounded-lg px-3 py-2" placeholder="City">
          <input id="chk-address" class="col-span-2 border rounded-lg px-3 py-2" placeholder="Street address">
        </div>
        <p class="text-[11px] text-gray-500 mt-2">Name must match your verified profile.</p>
      </div>

      <!-- DIGITAL DELIVERY -->
      <div id="chk-digital-box" class="hidden border rounded-lg p-3">
        <div class="text-xs text-gray-600 mb-1">Delivery email</div>
        <input id="chk-email" class="border rounded-lg px-3 py-2 w-full" placeholder="you@email.com">
        <p class="text-[11px] text-gray-500 mt-2">We send codes instantly after review.</p>
      </div>

      <div class="p-3 rounded-lg bg-emerald-50 border border-emerald-200">
        <div class="text-xs text-emerald-800">You will spend</div>
        <div id="chk-spend" class="text-lg font-bold text-emerald-700">‚Äî Lukas</div>
      </div>

      <label class="flex items-start gap-2 text-xs">
        <input id="chk-ack" type="checkbox" class="mt-0.5 accent-primary">
        <span>I confirm I am 18+, my profile is complete (ID & email verified), and I accept the <a href="#" class="underline" id="chk-terms-link">Terms & Conditions</a>.</span>
      </label>

      <div id="chk-error" class="hidden text-sm text-red-600 bg-red-50 border border-red-200 rounded p-2"></div>
    </div>

    <div class="mt-4 flex gap-2">
      <button id="chk-confirm" class="flex-1 bg-primary text-white rounded-lg py-2 text-sm font-semibold disabled:opacity-40 disabled:cursor-not-allowed">
        Confirm redemption
      </button>
      <button id="chk-cancel" class="flex-1 border rounded-lg py-2 text-sm hover:bg-gray-50">Cancel</button>
    </div>
  </div>
</div>

<!-- SIMPLE ORDERS MODAL -->
<div id="orders-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-[80]">
  <div class="bg-white rounded-2xl w-full max-w-2xl p-6 shadow-xl">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold">My orders</h3>
      <button id="orders-close" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100"><i class="fa-solid fa-xmark text-gray-500"></i></button>
    </div>
    <div id="orders-list" class="mt-3 divide-y text-sm"></div>
    <div class="mt-3 text-xs text-gray-500">Need help? Contact support with your Order ID.</div>
  </div>
</div>
</body></html>
